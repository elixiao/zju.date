<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>zju.date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在 Vue 框架里面内置了一个模板引擎，用于编译 Vue 专有语法，例如： 12345678910&amp;lt;div id=&quot;app&quot;&amp;gt;  你好，&amp;#123;&amp;#123; message &amp;#125;&amp;#125;！  &amp;lt;p v-if=&quot;seen&quot; styles=&quot;color: red; fontSize: 16px&quot;&amp;gt;条件渲染&amp;lt;/p&amp;gt;  &amp;lt;button v-on:c">
<meta name="keywords" content="JavaScript">
<meta property="og:type" content="article">
<meta property="og:title" content="模板引擎实现原理（Vue篇）">
<meta property="og:url" content="https://zju.date/template-engine-vue/index.html">
<meta property="og:site_name" content=".">
<meta property="og:description" content="在 Vue 框架里面内置了一个模板引擎，用于编译 Vue 专有语法，例如： 12345678910&amp;lt;div id=&quot;app&quot;&amp;gt;  你好，&amp;#123;&amp;#123; message &amp;#125;&amp;#125;！  &amp;lt;p v-if=&quot;seen&quot; styles=&quot;color: red; fontSize: 16px&quot;&amp;gt;条件渲染&amp;lt;/p&amp;gt;  &amp;lt;button v-on:c">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-08-10T06:16:46.055Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="模板引擎实现原理（Vue篇）">
<meta name="twitter:description" content="在 Vue 框架里面内置了一个模板引擎，用于编译 Vue 专有语法，例如： 12345678910&amp;lt;div id=&quot;app&quot;&amp;gt;  你好，&amp;#123;&amp;#123; message &amp;#125;&amp;#125;！  &amp;lt;p v-if=&quot;seen&quot; styles=&quot;color: red; fontSize: 16px&quot;&amp;gt;条件渲染&amp;lt;/p&amp;gt;  &amp;lt;button v-on:c">
  
    <link rel="alternate" href="/atom.xml" title="." type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/banner.jpg">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">.</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      <div id="search-form-wrap">
        
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-template-engine-vue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/template-engine-vue/" class="article-date">
  <time datetime="2020-02-06T13:33:00.000Z" itemprop="datePublished">2020-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      模板引擎实现原理（Vue篇）
    </h1>
  

      </header>
    



    <div class="article-entry" itemprop="articleBody">
      
        <p>在 Vue 框架里面内置了一个模板引擎，用于编译 Vue 专有语法，例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  你好，&#123;&#123; message &#125;&#125;！</span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">"seen"</span> <span class="attr">styles</span>=<span class="string">"color: red; fontSize: 16px"</span>&gt;</span>条件渲染<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">v-on:click</span>=<span class="string">"reverseMessage"</span>&gt;</span>反转消息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"todo in todos"</span> <span class="attr">class</span>=<span class="string">"color-gray ml-2"</span>&gt;</span></span><br><span class="line">      &#123;&#123; todo.text &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里面有 <code></code>、<code>v-if</code>、<code>v-on:click</code>、<code>v-for</code> 等特殊的语法，Vue 需要把这些内容提取出来，转换成响应式的函数或者对应的 DOM 事件。</p>
<p>在 Vue 中同样是用正则来提取这些内容的，它的转化流程如下：</p>
<ul>
<li>通过正则把模板转换成 AST 抽象语法树</li>
<li>用 AST 生成 JS 代码</li>
<li>用 <code>new Function</code> 配合 <code>with</code> 来执行 JS 代码</li>
</ul>
<a id="more"></a>
<h2 id="AST-抽象语法树"><a href="#AST-抽象语法树" class="headerlink" title="AST 抽象语法树"></a>AST 抽象语法树</h2><p>AST 中的节点是具有特殊属性的 JS 对象，它的结构大致如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  tag: tagName, <span class="comment">// 标签名</span></span><br><span class="line">  type: <span class="number">1</span>, <span class="comment">// 元素类型</span></span><br><span class="line">  children: [], <span class="comment">// 孩子列表</span></span><br><span class="line">  attrs, <span class="comment">// 属性集合</span></span><br><span class="line">  parent: <span class="literal">null</span>, <span class="comment">// 父元素</span></span><br><span class="line">  text: <span class="literal">null</span> <span class="comment">// 文本节点内容</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 AST 抽象语法树中，会按照节点类型的不同进行区分：</p>
<ul>
<li>元素类型</li>
<li>文本类型</li>
<li>注释类型</li>
<li>…</li>
</ul>
<h2 id="正则分析"><a href="#正则分析" class="headerlink" title="正则分析"></a>正则分析</h2><p>接下来开始用正则对节点进行提取，先看下 Vue 中定义的正则：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ncname = <span class="string">`[a-zA-Z_][\\-\\.0-9_a-zA-Z]*`</span>; <span class="comment">// 标签名</span></span><br><span class="line"><span class="keyword">const</span> qnameCapture = <span class="string">`((?:<span class="subst">$&#123;ncname&#125;</span>\\:)?<span class="subst">$&#123;ncname&#125;</span>)`</span>; <span class="comment">// ?: 表示匹配不捕获</span></span><br><span class="line"><span class="keyword">const</span> startTagOpen = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;<span class="subst">$&#123;qnameCapture&#125;</span>`</span>); <span class="comment">// 标签开头的正则 捕获的内容是标签名</span></span><br><span class="line"><span class="keyword">const</span> endTag = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;\\/<span class="subst">$&#123;qnameCapture&#125;</span>[^&gt;]*&gt;`</span>); <span class="comment">// 匹配标签结尾的 &lt;/div&gt;</span></span><br><span class="line"><span class="keyword">const</span> attribute = <span class="regexp">/^\s*([^\s"'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=&lt;&gt;`]+)))?/</span>; <span class="comment">// 匹配属性</span></span><br><span class="line"><span class="keyword">const</span> startTagClose = <span class="regexp">/^\s*(\/?)&gt;/</span>; <span class="comment">// 匹配标签结束的 &gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ncname"><a href="#ncname" class="headerlink" title="ncname"></a>ncname</h3><p>ncname 就是不包含前缀的XML标签名称，规则如下：</p>
<blockquote>
<p>字母（a-zA-Z）或下划线（_）开头，后面可以跟任意数量的：</p>
<ul>
<li>中横线（-）</li>
<li>点（.）</li>
<li>数字（0-9）</li>
<li>下划线（_）</li>
<li>字母（a-zA-Z）</li>
</ul>
</blockquote>
<h3 id="qname-和-qnameCapture"><a href="#qname-和-qnameCapture" class="headerlink" title="qname 和 qnameCapture"></a>qname 和 qnameCapture</h3><p>qname 是合法的 XML 标签，它的组成规则是 <code>&lt;前缀:标签名称&gt;</code>，例如：<code>&lt;abc:span&gt;&lt;/abc:span&gt;</code>，其中前缀可以省略，也就是说，可能是一个 ncname，或者两个 ncname 中间通过冒号拼接起来。</p>
<p>这个正则中冒号和冒号前面的部分是一个非捕获分组，后面的标签名是捕获分组，即可以取到标签名称。</p>
<h3 id="startTagOpen"><a href="#startTagOpen" class="headerlink" title="startTagOpen"></a>startTagOpen</h3><p>匹配开始标签，例如 <code>&lt;div</code>、<code>&lt;abc:span</code>。</p>
<h3 id="endTag"><a href="#endTag" class="headerlink" title="endTag"></a>endTag</h3><p>来匹配结束标签</p>
<h3 id="attribute"><a href="#attribute" class="headerlink" title="attribute"></a>attribute</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^\s*([^\s&quot;&apos;&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|&apos;([^&apos;]*)&apos;+|([^\s&quot;&apos;=&lt;&gt;`]+)))?/</span><br></pre></td></tr></table></figure>
<p>这个正则比较长，是用于匹配 HTML 标签属性的，可能的属性写法有：</p>
<ul>
<li>双引号：<code>class=&quot;some-class&quot;</code></li>
<li>单引号：<code>class=&#39;some-class&#39;</code></li>
<li>不用引号：<code>class=some-class</code></li>
<li>单独的属性名：<code>disabled</code></li>
</ul>
<p>这个表达式有五个捕获组，第一个捕获组用来匹配属性名，第二个捕获组用来匹配等于号，第三、第四、第五个捕获组都是用来匹配属性值的，同时 ? 表明第三、四、五个分组是可选的。</p>
<h3 id="startTagClose"><a href="#startTagClose" class="headerlink" title="startTagClose"></a>startTagClose</h3><p>用于匹配结束标签，例如：<code>br /&gt;</code> 或 <code>/div&gt;</code>。</p>
<h2 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h2><p>利用上面的正则，可以写出下面简化版 AST 解析器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> root, parent, stack = []</span><br><span class="line">  <span class="comment">// 只要剩余的 html 不为空就一直解析</span></span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    <span class="keyword">let</span> textEnd = html.indexOf(<span class="string">'&lt;'</span>)</span><br><span class="line">    <span class="keyword">if</span> (textEnd == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; tag, attrs &#125; = parseStartTag() || &#123;&#125;</span><br><span class="line">      <span class="keyword">if</span> (tag) &#123;</span><br><span class="line">        start(tag, attrs)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> endTagMatch = html.match(endTag)</span><br><span class="line">      <span class="keyword">if</span> (endTag) &#123;</span><br><span class="line">        advance(endTagMatch[<span class="number">0</span>].length)</span><br><span class="line">        end(endTagMatch[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> text = textEnd &gt; <span class="number">0</span> ? html.substring(<span class="number">0</span>, textEnd) : html</span><br><span class="line">      advance(text.length)</span><br><span class="line">      chars(text)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取截取后剩余的html</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">advance</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    html = html.substring(n)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析开始标签</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseStartTag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> start = html.match(startTagOpen)</span><br><span class="line">    <span class="keyword">if</span> (start) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = &#123; <span class="attr">tag</span>: start[<span class="number">1</span>], <span class="attr">attrs</span>: [] &#125;</span><br><span class="line">      advance(start[<span class="number">0</span>].length)</span><br><span class="line">      <span class="keyword">let</span> end, attr</span><br><span class="line">      <span class="keyword">while</span> (</span><br><span class="line">        !(end = html.match(startTagClose)) &amp;&amp;</span><br><span class="line">        (attr = html.match(attribute))</span><br><span class="line">      ) &#123;</span><br><span class="line">        match.attrs.push(&#123;</span><br><span class="line">          name: attr[<span class="number">1</span>],</span><br><span class="line">          value: attr[<span class="number">3</span>] || attr[<span class="number">4</span>] || attr[<span class="number">5</span>],</span><br><span class="line">        &#125;)</span><br><span class="line">        advance(attr[<span class="number">0</span>].length)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (end) &#123;</span><br><span class="line">        advance(end[<span class="number">0</span>].length)</span><br><span class="line">        <span class="keyword">return</span> match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析到开始标签时触发</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">tag, attrs</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> el = createASTElement(tag, attrs)</span><br><span class="line">    <span class="keyword">if</span> (!root) root = el</span><br><span class="line">    stack.push((parent = el))</span><br><span class="line">    processFor(el) <span class="comment">// 处理 v-for</span></span><br><span class="line">    processIf(el) <span class="comment">// 处理 v-if</span></span><br><span class="line">    processAttrs(el) <span class="comment">// 处理 v-on、v-show、v-bind 等</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析到结束标签时触发</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params">tag</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> el = stack.pop()</span><br><span class="line">    parent = stack[stack.length - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">      el.parent = parent</span><br><span class="line">      parent.children.push(el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析到文本时触发</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">chars</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    text = text.trim()</span><br><span class="line">    <span class="keyword">if</span> (!text) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> el = &#123; <span class="attr">type</span>: <span class="number">3</span>, text &#125;</span><br><span class="line">    <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">      parent.children.push(el)</span><br><span class="line">      el.parent = parent</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建元素节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createASTElement</span>(<span class="params">tag, attrs, parent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="number">1</span>,</span><br><span class="line">    tag,</span><br><span class="line">    attrsList: attrs,</span><br><span class="line">    attrsMap: makeAttrsMap(attrs),</span><br><span class="line">    parent,</span><br><span class="line">    children: [],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 把数组类型的属性转换为对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeAttrsMap</span>(<span class="params">attrs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> map = &#123;&#125;</span><br><span class="line">  attrs.forEach(<span class="function">(<span class="params">it</span>) =&gt;</span> (map[it.name] = it.value))</span><br><span class="line">  <span class="keyword">return</span> map</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取并删除数组中的某个属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAndRemoveAttr</span>(<span class="params">el, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> val</span><br><span class="line">  <span class="keyword">if</span> ((val = el.attrsMap[name]) != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> list = el.attrsList</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = list.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">if</span> (list[i].name === name) &#123;</span><br><span class="line">        list.splice(i, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理v-for</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processFor</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> exp</span><br><span class="line">  <span class="keyword">if</span> ((exp = getAndRemoveAttr(el, <span class="string">'v-for'</span>))) &#123;</span><br><span class="line">    <span class="keyword">const</span> inMatch = exp.match(<span class="regexp">/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/</span>)</span><br><span class="line">    <span class="keyword">if</span> (!inMatch) <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">Object</span>.assign(el, &#123;</span><br><span class="line">      alias: inMatch[<span class="number">1</span>].trim(),</span><br><span class="line">      <span class="keyword">for</span>: inMatch[<span class="number">2</span>].trim(),</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理v-if</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processIf</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> exp = getAndRemoveAttr(el, <span class="string">'v-if'</span>)</span><br><span class="line">  <span class="keyword">if</span> (exp) el.if = exp</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理各种属性，这里以v-on为例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processAttrs</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> list = el.attrsList,</span><br><span class="line">    onRE = <span class="regexp">/^@|^v-on:/</span></span><br><span class="line">  <span class="keyword">let</span> i, l, name, rawName, value</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = list.length; i &lt; l; i++) &#123;</span><br><span class="line">    name = rawName = list[i].name</span><br><span class="line">    value = list[i].value</span><br><span class="line">    <span class="keyword">if</span> (onRE.test(name)) &#123;</span><br><span class="line">      name = name.replace(onRE, <span class="string">''</span>)</span><br><span class="line">      el.events = &#123; [name]: value &#125;</span><br><span class="line">      list.splice(i, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对文章开头的示例模板运行这段代码，可以得到如下的 AST 树：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="number">1</span>,</span><br><span class="line">  tag: <span class="string">'div'</span>,</span><br><span class="line">  attrsList: [ &#123; <span class="attr">name</span>: <span class="string">'id'</span>, <span class="attr">value</span>: <span class="string">'app'</span> &#125; ],</span><br><span class="line">  attrsMap: &#123; <span class="attr">id</span>: <span class="string">'app'</span> &#125;,</span><br><span class="line">  children: [</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">'你好，&#123;&#123; message &#125;&#125;！'</span> &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="number">1</span>,</span><br><span class="line">      tag: <span class="string">'p'</span>,</span><br><span class="line">      attrsList: [ &#123; <span class="attr">name</span>: <span class="string">'style'</span>, <span class="attr">value</span>: <span class="string">'color: red; fontSize: 16px'</span> &#125; ],</span><br><span class="line">      attrsMap: &#123; <span class="string">'v-if'</span>: <span class="string">'seen'</span>, <span class="attr">style</span>: <span class="string">'color: red; fontSize: 16px'</span> &#125;,</span><br><span class="line">      children: [ &#123; <span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">'条件渲染'</span> &#125; ],</span><br><span class="line">      <span class="keyword">if</span>: <span class="string">'seen'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="number">1</span>,</span><br><span class="line">      tag: <span class="string">'button'</span>,</span><br><span class="line">      attrsList: [],</span><br><span class="line">      attrsMap: &#123; <span class="string">'v-on:click'</span>: <span class="string">'reverseMessage'</span> &#125;,</span><br><span class="line">      children: [ &#123; <span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">'反转消息'</span> &#125; ],</span><br><span class="line">      events: &#123; <span class="attr">click</span>: <span class="string">'reverseMessage'</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="number">1</span>,</span><br><span class="line">      tag: <span class="string">'ol'</span>,</span><br><span class="line">      attrsList: [],</span><br><span class="line">      attrsMap: &#123;&#125;,</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          type: <span class="number">1</span>,</span><br><span class="line">          tag: <span class="string">'li'</span>,</span><br><span class="line">          attrsList: [ &#123; <span class="attr">name</span>: <span class="string">'class'</span>, <span class="attr">value</span>: <span class="string">'color-gray ml-2'</span> &#125; ],</span><br><span class="line">          attrsMap: &#123; <span class="string">'v-for'</span>: <span class="string">'todo in todos'</span>, <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;,</span><br><span class="line">          children: [ &#123; <span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">'&#123;&#123; todo.text &#125;&#125;'</span> &#125; ],</span><br><span class="line">          alias: <span class="string">'todo'</span>,</span><br><span class="line">          <span class="keyword">for</span>: <span class="string">'todos'</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里并没有对注释节点等进行解析，只处理了元素节点和文本节点。</p>
<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><p>有了 AST 之后，就需要将其组装成代码了，本质上就是拼接代码字符串，用 <code>new Function</code> 和 <code>with</code> 进行处理。所以接下来要写一个函数来处理上面的 AST 树：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> node.type === <span class="number">1</span> ? genElement(node) : genText(node.text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样这里只考虑元素节点和文本节点两种情况。</p>
<h3 id="生成元素节点代码"><a href="#生成元素节点代码" class="headerlink" title="生成元素节点代码"></a>生成元素节点代码</h3><p>对于元素节点，要拼成 <code>_c(tag, data, childNodes)</code> 函数，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genElement</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; tag, attrsList, children &#125; = el</span><br><span class="line">  <span class="keyword">const</span> childNodes = children.map(<span class="function">(<span class="params">child</span>) =&gt;</span> generate(child))</span><br><span class="line">  <span class="keyword">if</span> (el.for &amp;&amp; !el.forProcessed) &#123;</span><br><span class="line">    el.forProcessed = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="string">`_l((<span class="subst">$&#123;el.<span class="keyword">for</span>&#125;</span>),`</span> +</span><br><span class="line">      <span class="string">`function(<span class="subst">$&#123;el.alias&#125;</span>)&#123;`</span> +</span><br><span class="line">      <span class="string">`return <span class="subst">$&#123;genElement(el)&#125;</span>`</span> +</span><br><span class="line">      <span class="string">'&#125;)'</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.if &amp;&amp; !el.ifProcessed) &#123;</span><br><span class="line">    el.ifProcessed = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;el.<span class="keyword">if</span>&#125;</span> ? <span class="subst">$&#123;genElement(el)&#125;</span>: _e('')`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`_c('<span class="subst">$&#123;tag&#125;</span>',<span class="subst">$&#123;genAttrs(attrsList)&#125;</span>,<span class="subst">$&#123;childNodes&#125;</span>)`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="处理元素节点上的属性"><a href="#处理元素节点上的属性" class="headerlink" title="处理元素节点上的属性"></a>处理元素节点上的属性</h3><p>下面的代码用于处理属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genAttrs</span>(<span class="params">attrs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; attrs.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> attr = attrs[i]</span><br><span class="line">    <span class="keyword">if</span> (attr.name === <span class="string">'style'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> kv = &#123;&#125; <span class="comment">// 对样式进行特殊的处理</span></span><br><span class="line">      attr.value.split(<span class="string">';'</span>).forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> [key, value] = item.split(<span class="string">':'</span>)</span><br><span class="line">        kv[key.trim()] = value.trim()</span><br><span class="line">      &#125;)</span><br><span class="line">      attr.value = kv</span><br><span class="line">    &#125;</span><br><span class="line">    obj[attr.name] = attr.value</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(obj)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生成文本节点代码"><a href="#生成文本节点代码" class="headerlink" title="生成文本节点代码"></a>生成文本节点代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genText</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> defaultTagRE = <span class="regexp">/\&#123;\&#123;((?:.|\r?\n)+?)\&#125;\&#125;/g</span></span><br><span class="line">  <span class="keyword">if</span> (!defaultTagRE.test(text)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`_v(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(text)&#125;</span>)`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> tokens = []</span><br><span class="line">  <span class="keyword">let</span> lastIndex = (defaultTagRE.lastIndex = <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">let</span> match, index</span><br><span class="line">  <span class="keyword">while</span> ((match = defaultTagRE.exec(text))) &#123;</span><br><span class="line">    index = match.index</span><br><span class="line">    <span class="keyword">if</span> (index &gt; lastIndex) &#123;</span><br><span class="line">      tokens.push(<span class="built_in">JSON</span>.stringify(text.slice(lastIndex, index)))</span><br><span class="line">    &#125;</span><br><span class="line">    tokens.push(<span class="string">`_s(<span class="subst">$&#123;match[<span class="number">1</span>].trim()&#125;</span>)`</span>)</span><br><span class="line">    lastIndex = index + match[<span class="number">0</span>].length</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (lastIndex &lt; text.length) &#123;</span><br><span class="line">    tokens.push(<span class="built_in">JSON</span>.stringify(text.slice(lastIndex)))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`_v(<span class="subst">$&#123;tokens.join(<span class="string">'+'</span>)&#125;</span>)`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码生成结果"><a href="#代码生成结果" class="headerlink" title="代码生成结果"></a>代码生成结果</h3><p>将 ast 带入函数得到代码字符串为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">_c(</span><br><span class="line">  <span class="string">'div'</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">'app'</span> &#125;,</span><br><span class="line">  _v(<span class="string">'你好，'</span> + _s(message) + <span class="string">'！'</span>),</span><br><span class="line">  seen</span><br><span class="line">    ? _c(<span class="string">'p'</span>, &#123; <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">'red'</span>, <span class="attr">fontSize</span>: <span class="string">'16px'</span> &#125; &#125;, _v(<span class="string">'条件渲染'</span>))</span><br><span class="line">    : _e(<span class="string">''</span>),</span><br><span class="line">  _c(<span class="string">'button'</span>, &#123;&#125;, _v(<span class="string">'反转消息'</span>)),</span><br><span class="line">  _c(</span><br><span class="line">    <span class="string">'ol'</span>,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">    _l(todos, <span class="function"><span class="keyword">function</span> (<span class="params">todo</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> _c(<span class="string">'li'</span>, &#123; <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;, _v(_s(todo.text)))</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="虚拟-DOM"><a href="#虚拟-DOM" class="headerlink" title="虚拟 DOM"></a>虚拟 DOM</h2><p>有了代码字符串之后，就可以带入环境变量来生成虚拟 DOM 了，下面是生成虚拟 DOM 用到的一些辅助函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_c</span>(<span class="params">tag, data, ...children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; tag, data, <span class="attr">children</span>: children.flat() &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_v</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; text &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_s</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (val == <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> val == <span class="string">'object'</span>) <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(val, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">String</span>(val)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_l</span>(<span class="params">val, render</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val.length)</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = val.length; i &lt; l; i++) &#123;</span><br><span class="line">    ret[i] = render(val[i], i)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_e</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; text, <span class="attr">isComment</span>: <span class="literal">true</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createVdom</span>(<span class="params">vm, code</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> f = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'vm'</span>, <span class="string">`with(vm)&#123;return <span class="subst">$&#123;code&#125;</span>&#125;`</span>)</span><br><span class="line">  <span class="keyword">return</span> f(&#123; ...vm, _c, _s, _v, _l, _e &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 vm 用下面的变量带入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  message: <span class="string">'消息'</span>,</span><br><span class="line">  seen: <span class="literal">false</span>,</span><br><span class="line">  todos: [&#123; <span class="attr">text</span>: <span class="string">'study'</span> &#125;, &#123; <span class="attr">text</span>: <span class="string">'reading'</span> &#125;],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会得到虚拟 DOM：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  tag: <span class="string">'div'</span>,</span><br><span class="line">  data: &#123; <span class="attr">id</span>: <span class="string">'app'</span> &#125;,</span><br><span class="line">  children: [</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">'你好，消息！'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">''</span>, <span class="attr">isComment</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">tag</span>: <span class="string">'button'</span>, <span class="attr">data</span>: &#123;&#125;, <span class="attr">children</span>: [ &#123; <span class="attr">text</span>: <span class="string">'反转消息'</span> &#125; ] &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      tag: <span class="string">'ol'</span>,</span><br><span class="line">      data: &#123;&#125;,</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          tag: <span class="string">'li'</span>,</span><br><span class="line">          data: &#123; <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;,</span><br><span class="line">          children: [ &#123; <span class="attr">text</span>: <span class="string">'study'</span> &#125; ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          tag: <span class="string">'li'</span>,</span><br><span class="line">          data: &#123; <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;,</span><br><span class="line">          children: [ &#123; <span class="attr">text</span>: <span class="string">'reading'</span> &#125; ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 vm 换成下面的环境：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  message: <span class="string">'水果'</span>,</span><br><span class="line">  seen: <span class="literal">true</span>,</span><br><span class="line">  todos: [&#123; <span class="attr">text</span>: <span class="string">'香蕉'</span> &#125;, &#123; <span class="attr">text</span>: <span class="string">'苹果'</span> &#125;, &#123; <span class="attr">text</span>: <span class="string">'西瓜'</span> &#125;],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>则可以生成另一种 DOM 结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  tag: <span class="string">'div'</span>,</span><br><span class="line">  data: &#123; <span class="attr">id</span>: <span class="string">'app'</span> &#125;,</span><br><span class="line">  children: [</span><br><span class="line">    &#123; <span class="attr">text</span>: <span class="string">'你好，水果！'</span> &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      tag: <span class="string">'p'</span>,</span><br><span class="line">      data: &#123; <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">'red'</span>, <span class="attr">fontSize</span>: <span class="string">'16px'</span> &#125; &#125;,</span><br><span class="line">      children: [ &#123; <span class="attr">text</span>: <span class="string">'条件渲染'</span> &#125; ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">tag</span>: <span class="string">'button'</span>, <span class="attr">data</span>: &#123;&#125;, <span class="attr">children</span>: [ &#123; <span class="attr">text</span>: <span class="string">'反转消息'</span> &#125; ] &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      tag: <span class="string">'ol'</span>,</span><br><span class="line">      data: &#123;&#125;,</span><br><span class="line">      children: [</span><br><span class="line">        &#123;</span><br><span class="line">          tag: <span class="string">'li'</span>,</span><br><span class="line">          data: &#123; <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;,</span><br><span class="line">          children: [ &#123; <span class="attr">text</span>: <span class="string">'香蕉'</span> &#125; ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          tag: <span class="string">'li'</span>,</span><br><span class="line">          data: &#123; <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;,</span><br><span class="line">          children: [ &#123; <span class="attr">text</span>: <span class="string">'苹果'</span> &#125; ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          tag: <span class="string">'li'</span>,</span><br><span class="line">          data: &#123; <span class="attr">class</span>: <span class="string">'color-gray ml-2'</span> &#125;,</span><br><span class="line">          children: [ &#123; <span class="attr">text</span>: <span class="string">'西瓜'</span> &#125; ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 vue 的数据是响应式的，数据改变会触发页面渲染，而页面渲染的逻辑就是新旧虚拟 DOM 利用 patch 算法进行比较得到差异，最终更新真实 DOM。</p>

      
    </div>
    <footer class="article-footer">
     <a data-url="https://zju.date/template-engine-vue/" data-id="ckej9qgbm00wewpq41xmcdone" class="article-share-link">Share</a>
     
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/flutter-flex-widgets/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Flutter flex布局组件
        
      </div>
    </a>
  
  
    <a href="/flutter-build-after-async-action/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">异步请求之后渲染页面</div>
    </a>
  
</nav>

  
</article>

</section>

        

      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CFA/">CFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dart/">Dart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/">Flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小程序/">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/诗歌/">诗歌</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
</aside>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 zju.date
      &nbsp;&nbsp;&nbsp;
      contact: <a href="mailto:zju.date@qq.com">zju.date@qq.com</a>
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>

<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>