<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>zju.date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ElasticSearch概述与传统数据库对比： 关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column) Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field) 一个 Elasticsearch 集群可以包含多个索引（数据库）">
<meta name="keywords" content="Database">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch学习笔记">
<meta property="og:url" content="https://zju.date/elasticsearch-notes/index.html">
<meta property="og:site_name" content=".">
<meta property="og:description" content="ElasticSearch概述与传统数据库对比： 关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column) Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field) 一个 Elasticsearch 集群可以包含多个索引（数据库）">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-02-17T02:41:14.892Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ElasticSearch学习笔记">
<meta name="twitter:description" content="ElasticSearch概述与传统数据库对比： 关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column) Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field) 一个 Elasticsearch 集群可以包含多个索引（数据库）">
  
    <link rel="alternate" href="/atom.xml" title="." type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/banner.jpg">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">.</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      <div id="search-form-wrap">
        
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-elasticsearch-notes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/elasticsearch-notes/" class="article-date">
  <time datetime="2016-05-12T05:32:36.000Z" itemprop="datePublished">2016-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ElasticSearch学习笔记
    </h1>
  

      </header>
    



    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ElasticSearch概述"><a href="#ElasticSearch概述" class="headerlink" title="ElasticSearch概述"></a>ElasticSearch概述</h2><p>与传统数据库对比：</p>
<pre><code>关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column)
Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field)
</code></pre><p>一个 Elasticsearch 集群可以包含多个索引（数据库），每个索引可以包含1个或多个（2.x版本）类型（表），这些类型中包含了多个文档（行），然后每个文档中又包含了很多的字段（列）。</p>
<a id="more"></a>
<p>需要注意的是：</p>
<ul>
<li>类型和数据库的表有很大区别，在同一个索引里面，不同的 type 应该有相同的结构，例如 id 字段不能在某种类型里面是字符串，另一种类型里面是数值。原因是同一索引中的不同 type 中的相同字段，存储结构是相同的。在 6.x 版本中索引只能有一个 type，7.x版本中不支持 type。</li>
</ul>
<ul>
<li>在关系数据库中，需要事先创建数据库，然后在该数据库实例下创建数据表，然后才能在该数据表中插入数据。而 ElasticSearch 中不需要事先定义映射（Mapping），文档写入 ElasticSearch 时，会根据文档字段自动识别类型，这种机制称之为动态映射。也可以事先定义好映射，包含文档的各个字段及其类型等，这种方式称之为静态映射。</li>
</ul>
<h3 id="索引（数据库）的增删改查"><a href="#索引（数据库）的增删改查" class="headerlink" title="索引（数据库）的增删改查"></a>索引（数据库）的增删改查</h3><ol>
<li><p>创建索引</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"mappings": &#123;</span></span><br><span class="line"><span class="string">		"_doc": &#123;</span></span><br><span class="line"><span class="string">			"properties": &#123;</span></span><br><span class="line"><span class="string">				"name": &#123;</span></span><br><span class="line"><span class="string">					"type": "keyword"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>也可以分两步来做：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_mapping/_doc?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "properties": &#123;</span></span><br><span class="line"><span class="string">    "name": &#123;</span></span><br><span class="line"><span class="string">      "type": "keyword"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_mapping/_doc?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "properties": &#123;</span></span><br><span class="line"><span class="string">    "email": &#123;</span></span><br><span class="line"><span class="string">      "type": "keyword"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>2.x 版本没有 text 和 keyword 字段，只有 string，5.x 版本引入这两个字段，并且抛弃 string</p>
<ul>
<li>keyword：存储数据时候，不会分词建立索引</li>
<li>text：存储数据时候，会自动分词，并生成索引<br>新老写法对比：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.x 写法</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"foo"</span>: &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">        <span class="string">"index"</span>: <span class="string">"analyzed"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 5.x 写法</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"foo"</span>: &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"text"</span>,</span><br><span class="line">        <span class="string">"index"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2.x 写法</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"foo"</span>: &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"string"</span>,</span><br><span class="line">        <span class="string">"index"</span>: <span class="string">"not_analyzed"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 5.x 写法</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"foo"</span>: &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</span><br><span class="line">        <span class="string">"index"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> <code>string</code> 字段被重新定义为 <code>text</code> 和 <code>keyword</code> 字段. 对于上面的 <code>index</code> 属性, 因为在新的定义中我们不需要三种状态(在以前的 <code>string</code> 定义中可以是 <code>analyzed</code>、 <code>not_analyzed</code> 和 <code>no</code>), 所以只简单的定义成了boolean值, 以告知ElasticSearch是否可在该字段上进行搜索.</p>
</li>
<li><p>查询</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有索引</span></span><br><span class="line">curl <span class="string">'localhost:9200/_cat/indices?v'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有映射</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_mapping?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定索引的映射</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test_v1/_doc/_mapping?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看设置</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test_v1/_settings?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试分词</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_analyze?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "analyzer" : "standard", # ik_max_word</span></span><br><span class="line"><span class="string">  "text" : "this is a test" # ["this is a test", "the second text"]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改映射</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "mappings": &#123;</span></span><br><span class="line"><span class="string">    "_doc": &#123;</span></span><br><span class="line"><span class="string">      "properties": &#123;</span></span><br><span class="line"><span class="string">        "name": &#123;</span></span><br><span class="line"><span class="string">          "properties": &#123;</span></span><br><span class="line"><span class="string">            "first": &#123;</span></span><br><span class="line"><span class="string">              "type": "text"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "user_id": &#123;</span></span><br><span class="line"><span class="string">          "type": "keyword"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以这样修改</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_mapping/_doc?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "properties": &#123;</span></span><br><span class="line"><span class="string">    "name": &#123;</span></span><br><span class="line"><span class="string">      "properties": &#123;</span></span><br><span class="line"><span class="string">        "last": &#123; </span></span><br><span class="line"><span class="string">          "type": "text"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "user_id": &#123;</span></span><br><span class="line"><span class="string">      "type": "keyword",</span></span><br><span class="line"><span class="string">      "ignore_above": 100 </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改设置</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_settings?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "index" : &#123;</span></span><br><span class="line"><span class="string">        "number_of_replicas" : 2</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line">curl -XPOST <span class="string">'localhost:9200/test_v1/_close?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改分词器设置</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_settings?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "analysis" : &#123;</span></span><br><span class="line"><span class="string">    "analyzer":&#123;</span></span><br><span class="line"><span class="string">      "content":&#123;</span></span><br><span class="line"><span class="string">        "type":"custom",</span></span><br><span class="line"><span class="string">        "tokenizer":"whitespace"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复开放</span></span><br><span class="line">curl -XPOST <span class="string">'localhost:9200/test_v1/_open?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">'localhost:9200/test_v1'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>别名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建别名</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_alias/test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新版本</span></span><br><span class="line">curl -XPOST <span class="string">'localhost:9200/_aliases?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "actions": [</span></span><br><span class="line"><span class="string">        &#123; "remove": &#123; "index": "test_v1", "alias": "test" &#125;&#125;,</span></span><br><span class="line"><span class="string">        &#123; "add":    &#123; "index": "test_v2", "alias": "test" &#125;&#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测别名指向哪个索引</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/*/_alias/test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测哪些别名指向这个索引</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_alias/*'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="文档（行）的增删改查"><a href="#文档（行）的增删改查" class="headerlink" title="文档（行）的增删改查"></a>文档（行）的增删改查</h3><ol>
<li><p>创建（Create）</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/test/_doc?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "method" : "create",</span></span><br><span class="line"><span class="string">    "service" : "sms",</span></span><br><span class="line"><span class="string">    "data" : "&#123;\"phone\":\"18860469266\",\"templateCode\":\"SMS_123673036\",\"content\":\"会员 刘祥 您好,您已经成功预约课程: 强力拉伸,上课时间：2017-12-18 20:30 \",\"fee\":0.045&#125;",</span></span><br><span class="line"><span class="string">    "club" : "5a7155a9fb5a680009103975",</span></span><br><span class="line"><span class="string">    "company" : "5a4b50fc07bf9d0005fabcf5",</span></span><br><span class="line"><span class="string">    "createdAt" : "2018-01-31T05:45:40.936Z"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> elasticsearch 会自动帮我们生成一个自动增加的 _id 或者 uuid，注意这里的 POST 不能改成 PUT，如果把 POST 改成 PUT 那么就会报错：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;error&quot;:&quot;Incorrect HTTP method for uri [/test/_doc] and method [PUT], allowed: [POST]&quot;,&quot;status&quot;:405&#125;</span><br></pre></td></tr></table></figure>
<p> 如果要新建一个指定 id 的项目的话，可以使用 PUT：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test/_doc/5a7152e48dd0b100064f34b5?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "method" : "create",</span></span><br><span class="line"><span class="string">    "ip" : "222.94.74.27",</span></span><br><span class="line"><span class="string">    "browser" : "chrome64.0.3282.119",</span></span><br><span class="line"><span class="string">    "service" : "login",</span></span><br><span class="line"><span class="string">    "data" : "&#123;\"target\":\"operation\",\"strategy\":\"staff\",\"username\":\"XXX001\",\"password\":\"14asvqrg\"&#125;",</span></span><br><span class="line"><span class="string">    "createdAt" : "2018-01-31T05:23:48.150Z"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> 如果 id 没有被使用，那么就是用给定的 id 进行创建，如果 id 已被占用的话，会覆盖原来的数据！所以不能使用这种方式进行指定id的创建，用下面的命令替代（<code>_create</code>可以换成<code>?op_type=create</code>）：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1/_create?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "method" : "create",</span></span><br><span class="line"><span class="string">    "browser" : "postmanruntime/6.4.1",</span></span><br><span class="line"><span class="string">    "service" : "sms",</span></span><br><span class="line"><span class="string">    "data" : "&#123;\"phone\":\"18375330275\",\"templateCode\":\"SMS_123797855\",\"fee\":0&#125;",</span></span><br><span class="line"><span class="string">    "_doc" : "5a7155a9fb5a68000910397f",</span></span><br><span class="line"><span class="string">    "club" : "5a7155a9fb5a680009103975",</span></span><br><span class="line"><span class="string">    "company" : "5a4b50fc07bf9d0005fabcf5",</span></span><br><span class="line"><span class="string">    "createdAt" : "2018-01-31T05:51:57.858Z"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> 如果查到 id 已经存在，那么会返回 error，http 状态码是 409。注意最后跟在 id 后面的_create不能少，如果没带这个的话就会覆盖原来已经存在的！（我发现把上面的PUT换成POST也是可以）</p>
</li>
<li><p>查询（Read）</p>
<p> a) 查询指定文档（单个数据）：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1?pretty'</span></span><br></pre></td></tr></table></figure>
<p> 返回结果分析：</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_index"</span> : <span class="string">"test_v1"</span>,</span><br><span class="line">    <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">    <span class="attr">"_id"</span> : <span class="string">"5a71597d8dd0b100064f34c1"</span>,</span><br><span class="line">    <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"_source"</span> : &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_index</code> 是索引</li>
<li><code>_type</code> 是类型</li>
<li><code>_id</code>是文档编号</li>
<li><code>_version</code>是修改次数</li>
<li><code>found</code> 是是否找到</li>
<li><p><code>_source</code> 是数据详情。</p>
<p>可以指定直接获取 _source:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1/_source?pretty'</span></span><br></pre></td></tr></table></figure>
<p>b) 查询(索引)(类型)下所有文档：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_search?pretty'</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span></span><br></pre></td></tr></table></figure>
<p>返回结果案例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;	</span><br><span class="line"><span class="attr">"took"</span> : <span class="number">98</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">16</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">16</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">30</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [ &#123;</span><br><span class="line">      <span class="attr">"_index"</span> : <span class="string">".kibana"</span>,</span><br><span class="line">      <span class="attr">"_type"</span> : <span class="string">"index-pattern"</span>,</span><br><span class="line">      <span class="attr">"_id"</span> : <span class="string">"cn.elixiao.search"</span>,</span><br><span class="line">      <span class="attr">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">"_source"</span> : &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>took 是整个搜索花费的毫秒数</p>
</li>
<li>time_out是查询是否超时</li>
<li>_shards是参与查询的分片总数，(total)中有多少是成功的(successful)或失败的(failed）</li>
<li>hits中total是匹配到的文档总数，max_score是给文档做相关性评分的最大值，hits数组是前10条数据。</li>
</ul>
</li>
<li><p>修改（Update）</p>
<p> PUT会基于id修改数据，如果这个ID已经存在数据，那么原数据将会被覆盖，如果要局部修改则需要：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1/_update?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "doc":&#123;</span></span><br><span class="line"><span class="string">    		"browser": "Chrome",</span></span><br><span class="line"><span class="string">      		"about": "I like shopping"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>注意这里的POST不能换成PUT，否则也会报类似的错误。

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Incorrect HTTP method for uri [/test/_doc/5a71597d8dd0b100064f34c1/_update?pretty] and method [PUT], allowed: [POST]</span><br></pre></td></tr></table></figure>

还要注意，doc里面的内容是被更新的内容，如果有这个字段就更新，如果没有这个字段就添加。
</code></pre><ol>
<li><p>删除：</p>
<p> 删除单个文档：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">'localhost:9200/test/_doc/_id'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="查询进阶"><a href="#查询进阶" class="headerlink" title="查询进阶"></a>查询进阶</h2><ol>
<li><p>指定查询字段：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_id?_source=method,data&amp;pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>只保留_source数据：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_id/_source?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检查文档是否存在（存在返回200，否则返回404）</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I -XHEAD <span class="string">'localhost:9200/test/_doc/_id?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询多个文档（muti-get）</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_mget?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "docs" : [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">         "_index" : "test",</span></span><br><span class="line"><span class="string">         "_type" :  "_doc",</span></span><br><span class="line"><span class="string">         "_id" :    2</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">         "_index" : "cn.elixiao.search",</span></span><br><span class="line"><span class="string">         "_type" :  "tweet",</span></span><br><span class="line"><span class="string">         "_id" :    1,</span></span><br><span class="line"><span class="string">         "_source": "views"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">   ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>过滤文档（分页）</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/_search?pretty&apos; -H &apos;Content-Type: application/json&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;from&quot;:2,</span><br><span class="line">	&quot;size&quot;:2</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>- size是结果数量，默认是10
- from是跳过开始的结果数，默认是0。

由于RFC 7231标准里面没有定义GET请求的request body，所以可以用POST请求或者下面的方法：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/_search?from=2&amp;size=2&amp;pretty&apos;</span><br></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>查看所有索引和类型：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/_mapping?pretty&apos;</span><br></pre></td></tr></table></figure>
<p>​</p>
<h2 id="查询DSL"><a href="#查询DSL" class="headerlink" title="查询DSL"></a>查询DSL</h2></li>
</ol>
<h3 id="一、简易查询（将所有参数放在查询字符串里面）"><a href="#一、简易查询（将所有参数放在查询字符串里面）" class="headerlink" title="一、简易查询（将所有参数放在查询字符串里面）"></a>一、简易查询（将所有参数放在查询字符串里面）</h3><p>查询test索引里面_doc类型中method字段包含patch的所有结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?q=method:patch&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>查询test索引里面_doc类型中method字段包含create，service字段包含sms的所有结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?q=+method:create+service:sms&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>注意这时候如果 method 有 create，service 不是 sms 的也会出现在结果里面，这是因为ES的结果是按照相关性排序的，由于 method 中出现了 create，所以有一定的相关性，但score会比较低。如果不指定索引、类型和字段，直接用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?q=post&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>会把所有索引不同类型任意字段中包含 post 的都找出来了。其实 ES 会把文档的所有字符串字段的值连接起来放在一个大的字符串中，它被索引为一个特殊的字段_all。因此可以构造更为复杂的查询：last_name为Smith，first_name为Jane，age小于30，任意字段中包含sports的结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?q=+last_name:Smith+first_name:Jane+age:&lt;30+sports&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>排序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?sort=service:asc&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "sort" : [</span></span><br><span class="line"><span class="string">        &#123; "service" : &#123;"order" : "asc"&#125; &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>如果出现下面的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [service] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.</span><br></pre></td></tr></table></figure>
<p> 默认 Elasticsearch 对 text 类型的字段是不可聚合的，基本类型可聚合，设置Fielddata = true 即可。</p>
<h3 id="二、结构化查询"><a href="#二、结构化查询" class="headerlink" title="二、结构化查询"></a>二、结构化查询</h3><p>查询DSL包括query DSL和filter DSL。</p>
<h4 id="query-DSL"><a href="#query-DSL" class="headerlink" title="query DSL"></a>query DSL</h4><p>语法格式：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search'</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>: YOUR_QUERY_HERE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>YOUR_QUERY_HERE查询子句里面的语法格式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        ARGUMENT: VALUE,</span><br><span class="line">        ARGUMENT: VALUE,...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果限制在特定的字段，用：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        FIELD_NAME: &#123;</span><br><span class="line">            ARGUMENT: VALUE,</span><br><span class="line">            ARGUMENT: VALUE,...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>例如你可以查询所有姓 Smith 的文档</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "last_name": "Smith"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>中文分词</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/cn.elixiao.search/tweet/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "message": "今天"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/index/fulltext/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "content": "伊拉克"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/index/fulltext/_mapping?pretty'</span></span><br><span class="line">	</span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "multi_match": &#123;</span></span><br><span class="line"><span class="string">            "last_name": "Smith",</span></span><br><span class="line"><span class="string">            "first_name": "Jane"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>指定多字段多查询：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "multi_match": &#123;</span></span><br><span class="line"><span class="string">            "query": "reading",</span></span><br><span class="line"><span class="string">            "fields": ["interests","about"]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>指定关键词全部匹配：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "about": "like reading"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>这个查询会把about字段里面只要包含like和reading其中一个都搜索出来，如果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "about": &#123;</span></span><br><span class="line"><span class="string">                "query":    "like reading",</span></span><br><span class="line"><span class="string">                "operator": "and"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>这样就能把about字段里面既包含like又包含reading的搜出来了。其实还有一种更灵活的方式来控制搜索结果，minimum_should_match选项可以指定最少应该匹配的数量。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "about": &#123;</span></span><br><span class="line"><span class="string">                "query":    "like reading rock",</span></span><br><span class="line"><span class="string">                "minimum_should_match": "2"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>由于事先不确定用户会输入的关键词数量，这里可以设置为百分比，例如75%。</p>
<p>合并查询子句：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">        <span class="string">"must"</span>:     &#123; <span class="string">"match"</span>: &#123; <span class="string">"tweet"</span>: <span class="string">"elasticsearch"</span> &#125;&#125;,</span><br><span class="line">        <span class="string">"must_not"</span>: &#123; <span class="string">"match"</span>: &#123; <span class="string">"name"</span>:  <span class="string">"mary"</span> &#125;&#125;,</span><br><span class="line">        <span class="string">"should"</span>:   &#123; <span class="string">"match"</span>: &#123; <span class="string">"tweet"</span>: <span class="string">"full text"</span> &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中：must：必须匹配，must_no：不许匹配，should：如果匹配的话得分更高，完整的案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"query": &#123;</span></span><br><span class="line"><span class="string">		"bool": &#123;</span></span><br><span class="line"><span class="string">			"must": &#123;</span></span><br><span class="line"><span class="string">				"match": &#123;</span></span><br><span class="line"><span class="string">					"sex": "男"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			"must_not": &#123;</span></span><br><span class="line"><span class="string">				"match": &#123;</span></span><br><span class="line"><span class="string">					"name": "Smith"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			"should": &#123;</span></span><br><span class="line"><span class="string">				"match": &#123;</span></span><br><span class="line"><span class="string">					"hobby": "reading"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>如果如果没传body，即空的{}，等价于：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search'</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"query"</span>: &#123;</span><br><span class="line">		<span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="filter-DSL"><a href="#filter-DSL" class="headerlink" title="filter DSL"></a>filter DSL</h4><p>区间过滤（range）：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"range": &#123;</span></span><br><span class="line"><span class="string">			"age": &#123;</span></span><br><span class="line"><span class="string">				"gt":  20,</span></span><br><span class="line"><span class="string">				"lte":   30</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>存在性过滤（exists）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"exists": &#123;</span></span><br><span class="line"><span class="string">			"field": "age"</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>缺失值过滤（missing）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"missing": &#123;</span></span><br><span class="line"><span class="string">			"field": "age"</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>精确匹配过滤（term）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"term": &#123;</span></span><br><span class="line"><span class="string">			"age": "33"</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>term和match的区别在于match会对查询语句进行分词，而term则搜索完整的语句，不做任何分词。（注意是查询语句，而不是数据库里面的字符串字段，如非特别标注，数据库里面的字符串字段总是会分词的）<br>​<br>多条件精确匹配过滤（terms）<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"terms": &#123;</span></span><br><span class="line"><span class="string">			"about": ["like","rock"]</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>排序（例如按照年龄进行倒序）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter" : &#123;</span></span><br><span class="line"><span class="string">		"range": &#123;</span></span><br><span class="line"><span class="string">			"age": &#123;</span></span><br><span class="line"><span class="string">				"gt":  20,</span></span><br><span class="line"><span class="string">				"lte": 30</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"sort": &#123; "age": &#123; "order": "desc" &#125;&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>当指定排序的时候，_score 字段就不会被计算，因为它没有用作排序。作为缩写，你可以只指定要排序的字段名称，例如：”sort”: “age”，那么字段值默认以顺序排列，这一点与_score默认以倒序排列不同。如果想指定多个排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter" : &#123;</span></span><br><span class="line"><span class="string">		"range": &#123;</span></span><br><span class="line"><span class="string">			"age": &#123;</span></span><br><span class="line"><span class="string">				"gt":  20,</span></span><br><span class="line"><span class="string">				"lte": 30</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"sort": [</span></span><br><span class="line"><span class="string">        &#123; "age":   &#123; "order": "desc" &#125;&#125;,</span></span><br><span class="line"><span class="string">        &#123; "first_name": &#123; "order": "asc" &#125;&#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>还有一种情况是，如果一个字段是一个集合，拥有多个值，那是否可以指定其中一个作为排序依据呢？答案是肯定的：对于数字和日期，你可以从多个值中取出一个来进行排序，你可以使用min, max, avg 或 sum这些模式， 比说你可以在 dates 字段中用最早的日期来进行排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"sort"</span>: &#123;</span><br><span class="line">    <span class="string">"dates"</span>: &#123;</span><br><span class="line">        <span class="string">"order"</span>: <span class="string">"asc"</span>,</span><br><span class="line">        <span class="string">"mode"</span>:  <span class="string">"min"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而对于多值字段字符串排序这种方法就不行了。比如字符串 “fine old art”，它最终会得到三个值。例如我们想要按照第一个词首字母排序， 如果第一个单词相同的话，再用第二个词的首字母排序，以此类推，可惜 ElasticSearch 在进行排序时 是得不到这些信息的。如果使用 min 和 max 模式来排（默认使用的是 min 模式）但它是依据art 或者 old排序， 而不是我们所期望的那样。</p>
<h3 id="四、查询和过滤混用"><a href="#四、查询和过滤混用" class="headerlink" title="四、查询和过滤混用"></a>四、查询和过滤混用</h3><p>单条过滤语句：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "filtered": &#123;</span></span><br><span class="line"><span class="string">            "filter":   &#123; "term": &#123; "folder": "inbox" &#125;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>带过滤的查询语句：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "filtered": &#123;</span></span><br><span class="line"><span class="string">            "query":  &#123; "match": &#123; "email": "business opportunity" &#125;&#125;,</span></span><br><span class="line"><span class="string">            "filter": &#123; "term": &#123; "folder": "inbox" &#125;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>验证查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_validate/query?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "query": &#123;</span></span><br><span class="line"><span class="string">      "_doc" : &#123;</span></span><br><span class="line"><span class="string">         "match" : "really powerful"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_validate/query?pretty&amp;explain'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "query": &#123;</span></span><br><span class="line"><span class="string">      "_doc" : &#123;</span></span><br><span class="line"><span class="string">         "match" : "really powerful"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>body里面：</p>
<p>sort<br>filter<br>query<br>from<br>size<br>aggs<br>_source</p>
<h3 id="五、批量操作"><a href="#五、批量操作" class="headerlink" title="五、批量操作"></a>五、批量操作</h3><p>批量操作文档（bulk）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/_bulk</span></span><br></pre></td></tr></table></figure>
<pre><code>{ &quot;delete&quot;: { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; }} 
{ &quot;create&quot;: { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; }}
{ &quot;title&quot;:    &quot;My first blog post&quot; }
{ &quot;index&quot;:  { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot; }}
{ &quot;title&quot;:    &quot;My second blog post&quot; }
{ &quot;update&quot;: { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot;, &quot;_retry_on_conflict&quot; : 3} }
{ &quot;doc&quot; : {&quot;title&quot; : &quot;My updated blog post&quot;} } 

一次性完成删除、指定id的创建、自动生成id的创建和更新。返回结果可能是这样的：

    {
       &quot;took&quot;: 4,
       &quot;errors&quot;: false, 
       &quot;items&quot;: [
          {  &quot;delete&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;123&quot;,
                &quot;_version&quot;: 2,
                &quot;status&quot;:   200,
                &quot;found&quot;:    true
          }},
          {  &quot;create&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;123&quot;,
                &quot;_version&quot;: 3,
                &quot;status&quot;:   201
          }},
          {  &quot;create&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;EiwfApScQiiy7TIKFxRCTw&quot;,
                &quot;_version&quot;: 1,
                &quot;status&quot;:   201
          }},
          {  &quot;update&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;123&quot;,
                &quot;_version&quot;: 4,
                &quot;status&quot;:   200
          }}
       ]
    }
</code></pre><p>对查询结果进行批量删除：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">"localhost:9200/test/_doc/_query?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "age": "30"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>一次性删除所有age为30的_doc，注意这个操作需要使用deleteByQuery插件，安装方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/plugin install delete-by-query</span><br></pre></td></tr></table></figure>
<p>安装完成之后一定要重启才可以。</p>
<p>在elasticsearch里面删除会影响到数据库吗？答案是不会！但是删除了数据库里面的数据，elasticsearch也会更新。注意，如果是标记-1为删除的话，要手动删除索引了？有没有标记呢？</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200//test/_doc/_search?q=last_name:Smith&amp;pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query" : &#123;</span></span><br><span class="line"><span class="string">        "filtered" : &#123;</span></span><br><span class="line"><span class="string">            "filter" : &#123;</span></span><br><span class="line"><span class="string">                "range" : &#123;</span></span><br><span class="line"><span class="string">                    "age" : &#123; "gt" : 30 &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "query" : &#123;</span></span><br><span class="line"><span class="string">                "match" : &#123;</span></span><br><span class="line"><span class="string">                    "last_name" : "Smith"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query" : &#123;</span></span><br><span class="line"><span class="string">        "match_phrase" : &#123;</span></span><br><span class="line"><span class="string">            "about" : "rock climbing"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">	"highlight": &#123;</span></span><br><span class="line"><span class="string">        "fields" : &#123;</span></span><br><span class="line"><span class="string">            "about" : &#123;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"query" : &#123;</span></span><br><span class="line"><span class="string">        "match" : &#123;</span></span><br><span class="line"><span class="string">            "last_name" : "smith"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">  "aggs": &#123;</span></span><br><span class="line"><span class="string">    "all_interests": &#123;</span></span><br><span class="line"><span class="string">      "terms": &#123; "field": "interests" &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/1?pretty'</span> </span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/grails-search/tweet/1?pretty'</span> </span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_aliases?pretty=1'</span></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/cn.elixiao.search/tweets/1?pretty'</span></span><br></pre></td></tr></table></figure>
<p>将elasticsearch作为守护进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -d</span><br></pre></td></tr></table></figure>
<p>即可！</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-service.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-service.html</a></p>
<p>注意有个坑，如果是所谓的transient properties的话，transient property是根据elasticsearch里面存储的信息计算出来的，如果字段没有被indexed，就会返回null，如果要避免此种情况发生就要为其设置setter。</p>
<p>访问elasticsearch文档的模式：</p>
<pre><code>curl -X&lt;REST Verb&gt; &lt;Node&gt;:&lt;Port&gt;/&lt;Index&gt;/&lt;Type&gt;/&lt;ID&gt;
</code></pre>
      
    </div>
    <footer class="article-footer">
     <a data-url="https://zju.date/elasticsearch-notes/" data-id="cjhn4lboo006gstq3pyhavvaw" class="article-share-link">Share</a>
     
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Database/">Database</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/git-notes/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Git干货集锦
        
      </div>
    </a>
  
  
    <a href="/css-notes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CSS学习笔记</div>
    </a>
  
</nav>

  
</article>

</section>

        

      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CFA/">CFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JAVA/">JAVA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/诗歌/">诗歌</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
</aside>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 zju.date
      &nbsp;&nbsp;&nbsp;
      contact: <a href="mailto:zju.date@qq.com">zju.date@qq.com</a>
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>

<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>