<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>zju.date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="安装安装方法：  Mac  1brew install openresty/brew/openresty  Centos  123yum install yum-utilsyum-config-manager --add-repo https://openresty.org/package/centos/openresty.repoyum install openresty   注意，在 Mac">
<meta name="keywords" content="Nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="openresty学习笔记">
<meta property="og:url" content="https://zju.date/openresty-notes/index.html">
<meta property="og:site_name" content=".">
<meta property="og:description" content="安装安装方法：  Mac  1brew install openresty/brew/openresty  Centos  123yum install yum-utilsyum-config-manager --add-repo https://openresty.org/package/centos/openresty.repoyum install openresty   注意，在 Mac">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-05-11T03:10:20.438Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="openresty学习笔记">
<meta name="twitter:description" content="安装安装方法：  Mac  1brew install openresty/brew/openresty  Centos  123yum install yum-utilsyum-config-manager --add-repo https://openresty.org/package/centos/openresty.repoyum install openresty   注意，在 Mac">
  
    <link rel="alternate" href="/atom.xml" title="." type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/banner.jpg">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">.</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      <div id="search-form-wrap">
        
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-openresty-notes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/openresty-notes/" class="article-date">
  <time datetime="2019-01-22T03:13:42.000Z" itemprop="datePublished">2019-01-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      openresty学习笔记
    </h1>
  

      </header>
    



    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装方法：</p>
<ol>
<li><p>Mac</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install openresty/brew/openresty</span><br></pre></td></tr></table></figure>
</li>
<li><p>Centos</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install yum-utils</span><br><span class="line">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</span><br><span class="line">yum install openresty</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>注意，在 Mac 上如果事先安装了 denji，需要先 untap：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew untap denji/nginx</span><br></pre></td></tr></table></figure>
<p>否则会出现下面的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TapFormulaAmbiguityError: Formulae found in multiple taps:</span><br><span class="line">       * openresty/brew/openresty-openssl</span><br><span class="line">       * denji/nginx/openresty-openssl</span><br><span class="line"></span><br><span class="line">Please use the fully-qualified name e.g. openresty/brew/openresty-openssl to refer the formula.</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>安装成功后提示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">To have launchd start openresty/brew/openresty now and restart at login:</span><br><span class="line">  brew services start openresty/brew/openresty</span><br><span class="line">Or, <span class="keyword">if</span> you don<span class="string">'t want/need a background service you can just run:</span></span><br><span class="line"><span class="string">  openresty</span></span><br><span class="line"><span class="string">==&gt; Summary</span></span><br><span class="line"><span class="string">🍺  /usr/local/Cellar/openresty/1.13.6.2: 293 files, 6.3MB, built in 1 minute 38 seconds</span></span><br></pre></td></tr></table></figure>
<p>进入安装后的目录（Mac上一般安装在 <code>/usr/local/Cellar/openresty/1.x.x.x/nginx/sbin</code> 目录），有如下子文件夹：</p>
<ul>
<li><code>bin</code>：存放可执行文件</li>
<li><code>luajit</code>：LuaJIT 运行库</li>
<li><code>lualib</code>：Lua 组件</li>
<li><code>nginx</code>：Nginx 核心运行平台</li>
<li><code>pod</code>：参考手册（restydoc）使用的数据</li>
<li><code>site</code>：包管理工具（opm）使用的数据</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>启动和停止 openresty 服务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">openresty</span><br><span class="line"><span class="comment"># 验证是否运行</span></span><br><span class="line">curl localhost</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">openresty -s stop</span><br></pre></td></tr></table></figure>
<p>常用命令：</p>
<ul>
<li>后台启动：<code>openresty</code></li>
<li>前台启动：<code>openresty -g &#39;daemon off;&#39;</code></li>
<li>停止：<code>openresty -s stop</code></li>
<li>重启：<code>openresty -s reload</code></li>
<li>检验 nginx 配置是否正确：<code>openresty -t</code></li>
</ul>
<p>找个目录，新建两个文件夹，其中 logs 目录用于存放日志，conf 用于存放配置文件。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span> logs/error.log;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">9000</span>;</span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">default_type</span> text/html;</span><br><span class="line">            <span class="attribute">content_by_lua</span> <span class="string">'</span></span><br><span class="line"><span class="string">                ngx.say("&lt;p&gt;Hello, World!&lt;/p&gt;")</span></span><br><span class="line"><span class="string">            '</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定配置文件运行</span></span><br><span class="line">openresty -p `<span class="built_in">pwd</span>`/ -c conf/nginx.conf</span><br><span class="line"><span class="comment"># 前台运行</span></span><br><span class="line">openresty -p `<span class="built_in">pwd</span>`/ -c conf/nginx.conf -g <span class="string">'daemon off;'</span></span><br><span class="line"><span class="comment"># 验证执行结果</span></span><br><span class="line">curl localhost:9000</span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">openresty -p `<span class="built_in">pwd</span>`/ -c conf/nginx.conf -s stop</span><br></pre></td></tr></table></figure>
<p>上面用了指令 content_by_lua，后面跟着一个字符串，当 lua 代码比较多的时候，就不合适了，这个时候可以用 content_by_lua_block 或者 content_by_lua_file 来直接写代码块或者引用外部 lua 文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    content_by_lua &apos;ngx.say(&quot;&lt;p&gt;Hello, World! content_by_lua&lt;/p&gt;&quot;)&apos;;</span><br><span class="line">    # 在conf文件里直接写代码块</span><br><span class="line">    content_by_lua_block &#123;</span><br><span class="line">        ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt; content_by_lua_block&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    # 引入外部lua文件，这里最好使用绝对路径，否则容易出现404错误</span><br><span class="line">    # 如果是相对路径的话，参照目录是 -p 指定的目录，可以使用 openresty -h 查看默认目录</span><br><span class="line">    content_by_lua_file /lua/hello-world.lua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h3><p>就像 npm 一样，openresty 也有一个组件库 opm，地址是 opm.openresty.org，可以使用 opm 命令把组件下载到本地进行管理，常用命令为：</p>
<ul>
<li><code>opm search xxx</code>：以关键词检索相关组件</li>
<li><code>opm get xxx</code>：安装组件（注意不是 install）</li>
<li><code>opm info xxx</code>：显示已安装组件的详细信息</li>
<li><code>opm remove xxx</code>：删除组件</li>
</ul>
<p>包xxx的格式为“作者名/组件名”，在安装的时候，opm 默认安装在 <code>site</code> 目录下，但用户可以指定安装路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 安装到 /opt 目录</span><br><span class="line">opm --install-dir=/opt get xxx </span><br><span class="line"># 安装到当前目录的 resty_modules 文件夹里面</span><br><span class="line">opm --cwd get xxx</span><br></pre></td></tr></table></figure>
<h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><p>bin 目录下有个 resty 命令是 Lua 语言的解释器，运行在 openresty 环境下，工作原理是启动了一个无服务的 Nginx 实例，禁用了 daemon 等大多数指令，也没有配置监听端口，只是在 worker 进程里用定时器让 Lua 代码在 Nginx 里执行。例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">resty -e <span class="string">"print('hello openresty')"</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">或者写一个文件：</span><br><span class="line"></span><br><span class="line">```lua</span><br><span class="line"><span class="comment">#!/usr/local/bin/resty</span></span><br><span class="line"><span class="built_in">local</span> n = <span class="comment">#arg</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"args count = "</span>, n)</span><br><span class="line"><span class="keyword">for</span> i = 1,n <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"arg "</span>, i, <span class="string">":"</span>, arg[i])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>上面的代码把参数逐一打印出来，运行效果如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ resty test.lua a b c d</span><br><span class="line">args count = 4</span><br><span class="line">arg 1:a</span><br><span class="line">arg 2:b</span><br><span class="line">arg 3:c</span><br><span class="line">arg 4:d</span><br></pre></td></tr></table></figure>
<h2 id="Nginx-基础知识"><a href="#Nginx-基础知识" class="headerlink" title="Nginx 基础知识"></a>Nginx 基础知识</h2><h4 id="http-服务基本语法："><a href="#http-服务基本语法：" class="headerlink" title="http 服务基本语法："></a>http 服务基本语法：</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        server_name: name;</span><br><span class="line">        <span class="attribute">location</span> uri &#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>server 配置：</p>
<ul>
<li>port 端口号</li>
<li>server_name 与 HTTP 请求头的 Host 字段进行匹配</li>
</ul>
</li>
<li><p>location 配置</p>
<p> location [=|~|~*|^~] uri {}</p>
<ul>
<li><code>=</code> 完全匹配</li>
<li><code>~</code> 大小写敏感匹配</li>
<li><code>~*</code> 大小写不敏感匹配</li>
<li><p><code>^~</code> 前缀匹配</p>
<p>location 在 server 块里面的顺序无关紧要，因为 Nginx 会对所有可能的匹配进行排序，查找最佳匹配。</p>
</li>
</ul>
</li>
</ol>
<h4 id="TCP-UDP-服务基本语法："><a href="#TCP-UDP-服务基本语法：" class="headerlink" title="TCP/UDP 服务基本语法："></a>TCP/UDP 服务基本语法：</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://nginx-xxx;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="string">"upgrade"</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">    proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上游集群"><a href="#上游集群" class="headerlink" title="上游集群"></a>上游集群</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server xxx:xx;</span><br><span class="line">    server xxx:xx weight=3;</span><br><span class="line">    server xxx:xx backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义访问日志格式</span></span><br><span class="line">log_format name format_string;</span><br><span class="line"><span class="comment"># 日志存储位置</span></span><br><span class="line">access_log path;</span><br><span class="line"><span class="comment"># 错误日志位置(不能自定义格式)</span></span><br><span class="line">error_log path level;</span><br></pre></td></tr></table></figure>
<p>我们在 content_by_lua 里面写了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngx.log(ngx.ERR, &quot;error&quot;)</span><br><span class="line">ngx.log(ngx.INFO, &quot;info&quot;)</span><br><span class="line">print([[i am print]])</span><br></pre></td></tr></table></figure>
<p>发现只有 error 在 error.log 中被打印出来了， info 和 print 都消失了，其实就是 level 的设置问题，如果设置成 debug，那么所有日志就都会出现了，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log /data/error.log [error_level];</span><br></pre></td></tr></table></figure>
<p>常见的错误日志级别从低到高是 debug、info、notice、warn、error、crit、alert、emerg，级别越高记录的信息越少，那些大于等于设置等级的日志均会被记录。生产场景一般用 warn | error | crit 这三个级别之一，尽量不要配置 info 等级较低的级别，因为这样会带来大量的磁盘I/O消耗。这些级别对应的 ngx 输出函数分别是：</p>
<ul>
<li><code>ngx.STDERR</code>：标准输出</li>
<li><code>ngx.EMERG</code>：紧急报错</li>
<li><code>ngx.ALERT</code>：报警</li>
<li><code>ngx.CRIT</code>：严重，系统故障， 触发运维告警系统</li>
<li><code>ngx.ERR</code>：错误，业务不可恢复性错误</li>
<li><code>ngx.WARN</code>：提醒，业务中可忽略错误</li>
<li><code>ngx.NOTICE</code>：提醒，业务中比较重要信息</li>
<li><code>ngx.INFO</code>：信息，业务琐碎日志信息， 包含不同情况判断等</li>
<li><code>ngx.DEBUG</code>：调试</li>
</ul>
<p>如果想打印在 access.log 中呢？可以用下面的办法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    log_format main &apos;[$time_local] $request $status $remote_addr $define_error_code&apos;;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        location / &#123;</span><br><span class="line">            set $define_error_code &apos;&apos;;</span><br><span class="line">            content_by_lua_block &#123;</span><br><span class="line">                ngx.var.define_error_code = 9527</span><br><span class="line">                ngx.say(&quot;hello world&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        access_log logs/access.log main;</span><br><span class="line">        error_log logs/error.log;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>errlog 记录日志时是直接写磁盘的阻塞操作，没有缓冲等优化措施，所以仅应该用来记录必要的错误信息和调试，不应该在实际的生产环境中频繁地调用此接口写磁盘文件，否则会极大地拖累 OpenResty，不过可以用 lua-resty-logger-socket 非阻塞的记录日志，即以非阻塞 IO 方式推送 access log 到远程服务器上。对远程服务器的要求是支持 syslog-ng 的日志服务。示例：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">log_by_lua_block &#123;</span><br><span class="line">    <span class="keyword">local</span> logger = <span class="built_in">require</span> <span class="string">"resty.logger.socket"</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logger.initted() <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> ok, err = logger.init&#123;</span><br><span class="line">            host = <span class="string">'xxx'</span>,</span><br><span class="line">            port = <span class="number">1234</span>,</span><br><span class="line">            flush_limit = <span class="number">1234</span>,</span><br><span class="line">            drop_limit = <span class="number">5678</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">            ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">'failed to initialize the logger: '</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> bytes, err = logger.<span class="built_in">log</span>(msg)</span><br><span class="line">    <span class="keyword">if</span> err <span class="keyword">then</span></span><br><span class="line">        ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">'failed to log message: '</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="Lua-语言概述"><a href="#Lua-语言概述" class="headerlink" title="Lua 语言概述"></a>Lua 语言概述</h2><h2 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h2><p>LuaJIT 是 Lua 语言的的非官方实现，包括一个汇编语言编写的解释器和一个 JIT 编译器，比官方解释器快很多。</p>
<p>openresty 核心组件</p>
<ol>
<li>Nginx</li>
<li>LuaJIT</li>
<li>ngx_lua(http_lua)</li>
<li>stream_lua</li>
</ol>
<p>一些应用场景：灰度发布、限流、参数安全校验、api网关</p>
<h2 id="LuaRocks"><a href="#LuaRocks" class="headerlink" title="LuaRocks"></a>LuaRocks</h2><p>LuaRocks 是 lua 的包管理器，下载地址 <a href="https://github.com/luarocks/luarocks/wiki/Download，如果是" target="_blank" rel="noopener">https://github.com/luarocks/luarocks/wiki/Download，如果是</a> Mac 可以直接用 brew 安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install luarocks</span><br></pre></td></tr></table></figure>
<p>luarocks 可以很方便的查找和安装第三方 Lua 模块，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">luarocks search json <span class="comment"># 查找json模块</span></span><br><span class="line">luarocks install lua-mongo <span class="comment"># 安装mongodb模块</span></span><br><span class="line">luarocks install redis-lua <span class="comment"># 安装redis模块</span></span><br><span class="line">luarocks install lua-cjson <span class="comment"># 安装json模块</span></span><br><span class="line">luarocks list  <span class="comment"># 查看已经安装的模块</span></span><br><span class="line">luarocks remove json4lua <span class="comment"># 卸载模块</span></span><br></pre></td></tr></table></figure>
<p>如果被查找的模块有很多的话，命令行输出不直观，也不知道哪个好哪个坏，此时可以去官网查找：<a href="http://luarocks.org/，里面有每个模块的作者、下载次数、上次更新时间等，一目了然。下面就去找一个" target="_blank" rel="noopener">http://luarocks.org/，里面有每个模块的作者、下载次数、上次更新时间等，一目了然。下面就去找一个</a> json 模块用于解析 json：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">luarocks install lua-cjson</span><br><span class="line">Installing https://luarocks.org/lua-cjson-2.1.0.6-1.src.rock</span><br><span class="line"></span><br><span class="line">env MACOSX_DEPLOYMENT_TARGET=10.8 gcc -O2 -fPIC -I/usr/<span class="built_in">local</span>/opt/lua/include/lua5.3 -c lua_cjson.c -o lua_cjson.o</span><br><span class="line">lua_cjson.c:743:19: warning: implicit declaration of <span class="keyword">function</span> <span class="string">'lua_objlen'</span> is invalid <span class="keyword">in</span> C99</span><br><span class="line">      [-Wimplicit-function-declaration]</span><br><span class="line">            len = lua_objlen(l, -1);</span><br><span class="line">                  ^</span><br><span class="line">1 warning generated.</span><br><span class="line">env MACOSX_DEPLOYMENT_TARGET=10.8 gcc -O2 -fPIC -I/usr/<span class="built_in">local</span>/opt/lua/include/lua5.3 -c strbuf.c -o strbuf.o</span><br><span class="line">env MACOSX_DEPLOYMENT_TARGET=10.8 gcc -O2 -fPIC -I/usr/<span class="built_in">local</span>/opt/lua/include/lua5.3 -c fpconv.c -o fpconv.o</span><br><span class="line">env MACOSX_DEPLOYMENT_TARGET=10.8 gcc -bundle -undefined dynamic_lookup -all_load -o cjson.so lua_cjson.o strbuf.o fpconv.o</span><br><span class="line">lua-cjson 2.1.0.6-1 is now installed <span class="keyword">in</span> /usr/<span class="built_in">local</span> (license: MIT)</span><br></pre></td></tr></table></figure>
<p>然后分别写一个 test.json 文件和 test.lua 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"hello"</span>: <span class="string">"lua"</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FileRead</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> file = <span class="built_in">io</span>.<span class="built_in">open</span>(<span class="string">"test.json"</span>,<span class="string">"r"</span>)</span><br><span class="line">  <span class="keyword">local</span> json = file:<span class="built_in">read</span>(<span class="string">"*a"</span>);</span><br><span class="line">  file:<span class="built_in">close</span>()</span><br><span class="line">  <span class="keyword">return</span> json</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">"cjson"</span></span><br><span class="line"><span class="keyword">local</span> file = FileRead()</span><br><span class="line"><span class="keyword">local</span> json = cjson.decode(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,w <span class="keyword">in</span> <span class="built_in">ipairs</span>(json.configs) <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"user:"</span>..w.user)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"password:"</span>..w.password)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"str:"</span>..json.str)</span><br></pre></td></tr></table></figure>
<p>运行发现报错了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">lua: error loading module <span class="string">'cjson'</span> from file <span class="string">'./test.lua'</span>:</span><br><span class="line">        ./test.lua:2: too many C levels (<span class="built_in">limit</span> is 200) <span class="keyword">in</span> <span class="keyword">function</span> at line 1 near <span class="string">'"test.json"'</span></span><br><span class="line">stack traceback:</span><br><span class="line">        [C]: <span class="keyword">in</span> ?</span><br><span class="line">        [C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'require'</span></span><br><span class="line">        ./test.lua:7: <span class="keyword">in</span> main chunk</span><br></pre></td></tr></table></figure>
<p>看错误信息可以定位到 require 函数出了问题。require 函数是用来加载模块的，而要加载一个模块，就必须的知道这个模块在哪里，只有知道了这个模块在哪里以后，才能进行正确的加载。<code>require xxx</code> 是如何找 xxx 模块的呢？其实是去 <code>LUA_PATH</code> 环境变量中找。require 会用模块名来替换每个问号 ?，然后根据替换的结果来检查是否存在这样一个文件，如果不存在，就会尝试下一项。路径中的每一项都是以分号隔开，比如路径为以下字符串：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?;?.lua;c:\windows\?;/usr/<span class="built_in">local</span>/lua/?/?.lua</span><br></pre></td></tr></table></figure>
<p>当我们 <code>require xxx</code> 时，就会尝试着打开以下文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xxx</span><br><span class="line">xxx.lua</span><br><span class="line">c:\windows\xxx</span><br><span class="line">/usr/<span class="built_in">local</span>/lua/xxx/xxx.lua</span><br></pre></td></tr></table></figure>
<p>require 函数只处理了分号和问号，其它的都是由路径自己定义的。在实际编程中，require 用于搜索的 Lua 文件的路径存放在变量 <code>package.path</code> 中，可以用 <code>print(package.path)</code> 输出全部路径：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/share/lua/5.3/?.lua;/usr/<span class="built_in">local</span>/share/lua/5.3/?/init.lua;/usr/<span class="built_in">local</span>/lib/lua/5.3/?.lua;/usr/<span class="built_in">local</span>/lib/lua/5.3/?/init.lua;./?.lua;./?/init.lua</span><br></pre></td></tr></table></figure>
<p>如果 require 无法找到与模块名相符的 Lua 文件，那 Lua 就会开始找 C 程序库；这个的搜索地址为 <code>package.cpath</code> 对应的地址，用 <code>print(package.cpath)</code> 会输出全部路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/lib/lua/5.3/?.so;/usr/local/lib/lua/5.3/loadall.so;./?.so</span><br></pre></td></tr></table></figure>
<p>所以 <code>lua_package_path</code> 和 <code>lua_package_cpath</code> 这两个环境变量很重要，在 OpenResty 中，这两个指令时运行 OpenResty 应用的关键，它们以字符串的形式确定 Lua 库和 so 库的查找路径，文件名使用 “?” 作为通配符，多个路径使用 “;” 分隔，默认的查找路径用 “;;”。例如在 nginx 中</p>
<p>指令里还可以使用特殊变量 “$prefix”，表示 OpenResty 启动时的工作目录（即 “-p” 参数指定的目录），这样就可以不使用绝对路径，配置更加灵活。例如在 nginx 配置中可以这么写：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    access_log logs/access.log;</span><br><span class="line">    lua_package_path <span class="string">"<span class="variable">$prefix</span>/lua_modules/share/lua/5.1/?.lua;;"</span>;</span><br><span class="line">    lua_package_cpath <span class="string">"<span class="variable">$prefix</span>/lua_modules/lib/lua/5.1/?.so;;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的指令告诉 OpenResty 在工作目录的 lua_modules 里查找 Lua 库和 *.so 库。我们不需要在指令里额外指定 OpenResty 的安装目录，这是因为在安装时 OpenResty 已经默认内置了自己的查找目录，即：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/openresty/lualib/?.lua</span><br><span class="line">/usr/<span class="built_in">local</span>/openresty/site/lualib/?.lua</span><br><span class="line">/usr/<span class="built_in">local</span>/openresty/lualib/?.so</span><br><span class="line">/usr/<span class="built_in">local</span>/openresty/site/lualib/?.so</span><br></pre></td></tr></table></figure>
<p>这里尤其需要注意一点，查找会首先从当前目录下查找，如果你引用了 cjson，然而你有给这个文件起名叫 cjson.lua 而不是 test.lua，就会报错，我在这里坑了很久…，改回 test.lua 就好了。更外，如果出现下面的报错：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lua: error loading module <span class="string">'cjson'</span> from file <span class="string">'/usr/local/lib/lua/5.3/cjson.so'</span>:</span><br><span class="line">        dlopen(/usr/<span class="built_in">local</span>/lib/lua/5.3/cjson.so, 6): Symbol not found: _lua_objlen</span><br><span class="line">  Referenced from: /usr/<span class="built_in">local</span>/lib/lua/5.3/cjson.so</span><br><span class="line">  Expected <span class="keyword">in</span>: flat namespace</span><br><span class="line"> <span class="keyword">in</span> /usr/<span class="built_in">local</span>/lib/lua/5.3/cjson.so</span><br><span class="line">stack traceback:</span><br><span class="line">        [C]: <span class="keyword">in</span> ?</span><br><span class="line">        [C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'require'</span></span><br><span class="line">        test.lua:7: <span class="keyword">in</span> main chunk</span><br><span class="line">        [C]: <span class="keyword">in</span> ?</span><br></pre></td></tr></table></figure>
<p>是因为 <code>2.1.0.6-1</code> 这个版本的有些问题，可以看到 cjson 被安装到 <code>/usr/local/lib/luarocks/rocks-5.3/lua-cjson/2.1.0.6-1</code> 下面，可以用下面的方法指定版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ luarocks remove lua-cjson</span><br><span class="line">$ luarocks install lua-cjson 2.1.0-1</span><br></pre></td></tr></table></figure>
<p>在 Mac 上安装 luarocks 之后，发现被我安装了两个版本的lua，5.1 和 5.3，这两个版本语法不兼容，而 OpenResty 使用的是 luajit 编译器，而 luajit 编译器仅支持 5.1 版本的 lua，并不支持 5.3 版本的。这就会带来一些问题，例如用 luarocks 安装之后依赖被放在了 <code>/usr/local/lib/lua/5.3</code> 目录下，但是 require 的时候 OpenResty 会从 <code>/usr/local/lib/lua/5.1</code> 中查找，查不到就会报错。好在可以安装依赖的时候指定 lua 的版本，默认情况下是 5.3，但是如果想用 5.1 就使用 <code>--lua-dir</code> 或 <code>--lua-version</code> 选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">luarocks --lua-dir=$(brew --prefix)/opt/lua@5.1 install say</span><br><span class="line">luarocks --lua-dir=/usr/<span class="built_in">local</span>/opt/lua@5.1 install lua-mongo </span><br><span class="line">luarocks --lua-version 5.1 install lua-mongo </span><br><span class="line">luarocks --lua-version 5.1 install redis-lua</span><br><span class="line">luarocks --lua-version 5.1 install lua-resty-url</span><br></pre></td></tr></table></figure>
<p>这样依赖会被安装到下面的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/xxx/.luarocks/lib/lua/5.1</span><br></pre></td></tr></table></figure>
<p>luarocks 安装依赖支持三种存储位置：</p>
<ul>
<li>全局Global（默认）：安装在系统级的位置，例如 /usr/share/lua/5.1</li>
<li>本地Local：用户 home 目录，用 <code>--local</code> 指定</li>
<li>自定义Custom：可以任意指定安装目录，用 <code>--tree some/directory</code></li>
</ul>
<p>更好的方式是自定义安装位置，我喜欢把它安装到当前目录的 lua_modules 目录下，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">luarocks --lua-version 5.1 install --tree lua_modules redis-lua</span><br><span class="line">luarocks --lua-version 5.1 install --tree lua_modules lua-mongo</span><br><span class="line">luarocks --lua-version 5.1 install --tree lua_modules lua-resty-url</span><br><span class="line">luarocks --lua-version 5.1 install --tree lua_modules lua-resty-http</span><br></pre></td></tr></table></figure>
<p>这个时候配置 path 和 cpath 的位置就是：</p>
<ul>
<li>path : <code>lua_modules/share/lua/5.1/?.lua</code></li>
<li>cpath: <code>lua_modules/lib/lua/5.1/?.so</code></li>
</ul>
<h2 id="Lua-连接-Redis、MongoDB-等示例"><a href="#Lua-连接-Redis、MongoDB-等示例" class="headerlink" title="Lua 连接 Redis、MongoDB 等示例"></a>Lua 连接 Redis、MongoDB 等示例</h2><h3 id="Lua-连接-Redis"><a href="#Lua-连接-Redis" class="headerlink" title="Lua 连接 Redis"></a>Lua 连接 Redis</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">'redis'</span></span><br><span class="line"><span class="keyword">local</span> client = redis.connect(<span class="string">'127.0.0.1'</span>, <span class="number">6379</span>)</span><br><span class="line"><span class="keyword">local</span> response = client:ping()    </span><br><span class="line"><span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line">client:set(<span class="string">'usr:nrk'</span>, <span class="number">10</span>)</span><br><span class="line">client:set(<span class="string">'usr:nobody'</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">local</span> value = client:get(<span class="string">'usr:nrk'</span>)</span><br><span class="line"><span class="built_in">print</span>(value)</span><br></pre></td></tr></table></figure>
<p>更多的示例在 <a href="https://github.com/nrk/redis-lua" target="_blank" rel="noopener">redis-lua官方仓库</a> 里面</p>
<h3 id="Lua-连接-MongoDB"><a href="#Lua-连接-MongoDB" class="headerlink" title="Lua 连接 MongoDB"></a>Lua 连接 MongoDB</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mongo = <span class="built_in">require</span> <span class="string">'mongo'</span></span><br><span class="line"><span class="keyword">local</span> client = mongo.Client <span class="string">'mongodb://username:password@mongodb-uri:27017/databaseName'</span></span><br><span class="line"><span class="keyword">local</span> collection = client:getCollection(<span class="string">'databaseName'</span>, <span class="string">'collectionName'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- count查询总数</span></span><br><span class="line"><span class="built_in">print</span>(collection:count(&#123;&#125;, &#123;&#125;))</span><br><span class="line"><span class="comment">-- findOne</span></span><br><span class="line"><span class="built_in">print</span>(collection:findOne(&#123;&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id = mongo.ObjectID()</span><br><span class="line"><span class="keyword">local</span> query = mongo.BSON &#123; _id = id &#125;</span><br><span class="line"><span class="built_in">print</span>(collection:findOne(query))</span><br></pre></td></tr></table></figure>
<p>更多的示例在 <a href="https://github.com/neoxic/lua-mongo/blob/master/test" target="_blank" rel="noopener">lua-mongo官方仓库</a> 里面，一个典型的应用场景是用 lua 将网页上收集到用户操作行为通过 OpenResty 写入 mongodb 中，但是 lua 直接操作mongodb 有很多缺陷，例如每次写入都要获取一个连接实例，开启一个连接，而网页上的行为收集是一个高并发的，会占用很多资源。不过网上有一些案例，可以用数据库连接池来优化这个问题，感兴趣的话可以搜搜看。</p>
<h2 id="在-docker-中使用-openresty-镜像"><a href="#在-docker-中使用-openresty-镜像" class="headerlink" title="在 docker 中使用 openresty 镜像"></a>在 docker 中使用 openresty 镜像</h2><p>[官方仓库][<a href="https://github.com/openresty/docker-openresty]" target="_blank" rel="noopener">https://github.com/openresty/docker-openresty]</a> 里面有很多镜像，例如： </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull openresty/openresty <span class="comment"># 默认镜像</span></span><br><span class="line">docker pull openresty/openresty:alpine <span class="comment"># 指定 alpine 镜像</span></span><br><span class="line">docker pull openresty/openresty:1.15.8.3-alpine <span class="comment"># 指定 openresty 的版本</span></span><br><span class="line">docker pull openresty/openresty:centos <span class="comment"># Centos 镜像</span></span><br><span class="line">docker pull openresty/openresty:xenial <span class="comment"># Ubuntu 镜像</span></span><br><span class="line">docker pull openresty/openresty:alpine-fat <span class="comment"># 胖 alpine 镜像</span></span><br></pre></td></tr></table></figure>
<p>其中默认的镜像是基于 Debian 的，体积相对较小：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openresty/openresty    latest           3c5b5f6743d4        2 weeks ago         84.8MB</span><br></pre></td></tr></table></figure>
<p>下面三个镜像是自带 luarocks 的，可以看到镜像都比较大了，其中最小的 centos 也要280M：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openresty/openresty    xenial           382416af27a3        2 weeks ago         551MB</span><br><span class="line">openresty/openresty    centos           a5fc4f8038a3        2 weeks ago         280MB</span><br><span class="line">openresty/openresty    alpine-fat       eef3ac05ac87        2 weeks ago         321MB</span><br></pre></td></tr></table></figure>
<p>在自带 luarocks 的容器内部可以直接安装第三方库：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">luarocks install lua-resty-url</span><br><span class="line">Installing https://luarocks.org/lua-resty-url-0.3.5-1.src.rock</span><br><span class="line"></span><br><span class="line">No existing manifest. Attempting to rebuild...</span><br><span class="line">lua-resty-url 0.3.5-1 is now installed <span class="keyword">in</span> /usr/<span class="built_in">local</span>/openresty/luajit (license: Apache License 2.0)</span><br></pre></td></tr></table></figure>
<p>默认的安装位置是：</p>
<ul>
<li>path: <code>/usr/local/openresty/luajit/lib/luarocks/rocks-5.1/?.lua</code></li>
<li>cpath：<code>/usr/local/openresty/luajit/lib/lua/5.1/?.so</code></li>
</ul>
<p>容器内 nginx 的配置路径在 <code>/usr/local/openresty/nginx/conf</code></p>

      
    </div>
    <footer class="article-footer">
     <a data-url="https://zju.date/openresty-notes/" data-id="ckckn9ogq00r2rvsejkj9zuot" class="article-share-link">Share</a>
     
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/gulp-in-deep/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          gulp 学习笔记
        
      </div>
    </a>
  
  
    <a href="/angular-video-autoPlay/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Angular 中 video 自动静音播放</div>
    </a>
  
</nav>

  
</article>

</section>

        

      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CFA/">CFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dart/">Dart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/">Flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小程序/">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/诗歌/">诗歌</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
</aside>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 zju.date
      &nbsp;&nbsp;&nbsp;
      contact: <a href="mailto:zju.date@qq.com">zju.date@qq.com</a>
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>

<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>