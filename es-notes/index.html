<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>zju.date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ElasticSearch概述与传统数据库的类比： 关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column) Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field) 一个 Elasticsearch 集群可以包含多个索引，每个索">
<meta name="keywords" content="Elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch学习笔记">
<meta property="og:url" content="https://zju.date/es-notes/index.html">
<meta property="og:site_name" content=".">
<meta property="og:description" content="ElasticSearch概述与传统数据库的类比： 关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column) Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field) 一个 Elasticsearch 集群可以包含多个索引，每个索">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-09-18T02:34:40.847Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ElasticSearch学习笔记">
<meta name="twitter:description" content="ElasticSearch概述与传统数据库的类比： 关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column) Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field) 一个 Elasticsearch 集群可以包含多个索引，每个索">
  
    <link rel="alternate" href="/atom.xml" title="." type="application/atom+xml">
  
  
    <link rel="icon" href="/css/images/banner.jpg">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">.</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      <div id="search-form-wrap">
        
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-es-notes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/es-notes/" class="article-date">
  <time datetime="2017-08-16T02:30:36.000Z" itemprop="datePublished">2017-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ElasticSearch学习笔记
    </h1>
  

      </header>
    



    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ElasticSearch概述"><a href="#ElasticSearch概述" class="headerlink" title="ElasticSearch概述"></a>ElasticSearch概述</h2><p>与传统数据库的类比：</p>
<pre><code>关系数据库      ⇒ 数据库(database) ⇒ 表(table)    ⇒ 行(row)         ⇒ 列(column)
Elasticsearch  ⇒ 索引(index)      ⇒ 类型(type)   ⇒ 文档(document)  ⇒ 字段(field)
</code></pre><p>一个 Elasticsearch 集群可以包含多个索引，每个索引可以包含1个类型，这个类型中包含多个文档，然后每个文档中又包含了很多的字段。但是在 6.x 的版本中 type <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html" target="_blank" rel="noopener">被废弃</a>了，在后期的版本中被完全移除，因此可以把 ES 想象成一个数据库只能容纳一个表。废弃的原因文档里面说得也比较清楚，在传统数据库中，表跟表之前是相互独立的，可以拥有不同的字段、不同的索引，但是在 ES 中，同一个索引下不同类型里名称相同的字段会被 Lucene 视为同一个字段，这就会产生矛盾，例如两个类型里面都有 deleted 字段，想在其中一个类型定义它是日期格式，另一个类型中定义它是布尔值，ES 做不到这一点，但数据库是可以做到的。</p>
<a id="more"></a>
<h3 id="索引的增删改查"><a href="#索引的增删改查" class="headerlink" title="索引的增删改查"></a>索引的增删改查</h3><ol>
<li><p>创建数据库和表结构</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ escurl -XPUT <span class="variable">$ES</span>/test_v1?pretty -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "settings" : &#123;</span></span><br><span class="line"><span class="string">      "number_of_shards" : 3,</span></span><br><span class="line"><span class="string">      "number_of_replicas" : 1</span></span><br><span class="line"><span class="string">   &#125;,</span></span><br><span class="line"><span class="string">	"mappings": &#123;</span></span><br><span class="line"><span class="string">		"_doc": &#123;</span></span><br><span class="line"><span class="string">			"properties": &#123;</span></span><br><span class="line"><span class="string">				"name": &#123;</span></span><br><span class="line"><span class="string">					"type": "keyword"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> 也可以分多步来做：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ escurl -XPUT <span class="variable">$ES</span>/test_v1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"acknowledged"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"shards_acknowledged"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"index"</span> : <span class="string">"test"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者指定分片和副本数量 </span></span><br><span class="line"><span class="comment"># number_of_replicas 是数据备份数，如果只有一台机器，设置为0</span></span><br><span class="line"><span class="comment"># number_of_shards 是数据分片数，7.0版本之前默认为5，7.0开始默认为1</span></span><br><span class="line">$ escurl -XPUT <span class="variable">$ES</span>/<span class="built_in">test</span>?pretty -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "settings":&#123;</span></span><br><span class="line"><span class="string">        "number_of_shards": 1,</span></span><br><span class="line"><span class="string">        "number_of_replicas": 1</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置表结构</span></span><br><span class="line">$ curl -XPUT <span class="variable">$ES</span>/test_v1/_mapping/_doc?pretty<span class="string">' -d'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"properties"</span>: &#123;</span><br><span class="line">    <span class="string">"name"</span>: &#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>keyword：存储数据时候，不会分词建立索引</li>
<li><p>text：存储数据时候，会自动分词，并生成索引</p>
<p>模糊搜索+精确匹配，一般是name或者title字段：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">"name": &#123;</span><br><span class="line">    "type": "text",</span><br><span class="line">    "analyzer": "ik_smart",</span><br><span class="line">    "fields": &#123;</span><br><span class="line">      "keyword": &#123;</span><br><span class="line">        "type": "keyword",</span><br><span class="line">        "ignore_above": 256</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<pre><code>模糊搜索，一般是内容详情字段：

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"content": &#123;</span><br><span class="line">    "type": "text",</span><br><span class="line">    "analyzer": "ik_smart"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



精确匹配：

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"name": &#123;</span><br><span class="line">    "type": "keyword"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


不需要索引：

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"url": &#123;</span><br><span class="line">    "type": "keyword",</span><br><span class="line">    "index": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


一旦索引被创建，就不能再修改分片数量了，例如下面的命令会报错 an&apos;t update non dynamic settings [[index.number_of_shards]] for open indices：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ escurl -XPUT $ES/test/_settings?pretty -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot;:&#123;</span><br><span class="line">        &quot;number_of_shards&quot;: 2, # 报错的原因在这里</span><br><span class="line">        &quot;number_of_replicas&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

总结：就是，不存在索引时,可以指定副本和分片，如果已经存在,则只能修改副本。
</code></pre><ol>
<li><p>查询数据库和表结构</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有索引</span></span><br><span class="line">curl <span class="string">'localhost:9200/_cat/indices?v'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有映射</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_mapping?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定索引的映射</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test_v1/_doc/_mapping?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看设置</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test_v1/_settings?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试分词</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_analyze?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "analyzer" : "standard", # ik_max_word</span></span><br><span class="line"><span class="string">  "text" : "this is a test" # ["this is a test", "the second text"]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改数据库和表结构</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改映射</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "mappings": &#123;</span></span><br><span class="line"><span class="string">    "_doc": &#123;</span></span><br><span class="line"><span class="string">      "properties": &#123;</span></span><br><span class="line"><span class="string">        "name": &#123;</span></span><br><span class="line"><span class="string">          "properties": &#123;</span></span><br><span class="line"><span class="string">            "first": &#123;</span></span><br><span class="line"><span class="string">              "type": "text"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "user_id": &#123;</span></span><br><span class="line"><span class="string">          "type": "keyword"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以这样修改</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_mapping/_doc?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "properties": &#123;</span></span><br><span class="line"><span class="string">    "name": &#123;</span></span><br><span class="line"><span class="string">      "properties": &#123;</span></span><br><span class="line"><span class="string">        "last": &#123; </span></span><br><span class="line"><span class="string">          "type": "text"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "user_id": &#123;</span></span><br><span class="line"><span class="string">      "type": "keyword",</span></span><br><span class="line"><span class="string">      "ignore_above": 100 </span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改设置</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_settings?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "index" : &#123;</span></span><br><span class="line"><span class="string">        "number_of_replicas" : 2</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时关闭</span></span><br><span class="line">curl -XPOST <span class="string">'localhost:9200/test_v1/_close?pretty'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改分词器设置</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_settings?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "analysis" : &#123;</span></span><br><span class="line"><span class="string">    "analyzer":&#123;</span></span><br><span class="line"><span class="string">      "content":&#123;</span></span><br><span class="line"><span class="string">        "type":"custom",</span></span><br><span class="line"><span class="string">        "tokenizer":"whitespace"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复开放</span></span><br><span class="line">curl -XPOST <span class="string">'localhost:9200/test_v1/_open?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除数据库</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">'localhost:9200/test_v1'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建别名</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建别名</span></span><br><span class="line">curl -XPUT <span class="string">'localhost:9200/test_v1/_alias/test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新版本</span></span><br><span class="line">curl -XPOST <span class="string">'localhost:9200/_aliases?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "actions": [</span></span><br><span class="line"><span class="string">        &#123; "remove": &#123; "index": "test_v1", "alias": "test" &#125;&#125;,</span></span><br><span class="line"><span class="string">        &#123; "add":    &#123; "index": "test_v2", "alias": "test" &#125;&#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测别名指向哪个索引</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/*/_alias/test'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测哪些别名指向这个索引</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_alias/*'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="文档的增删改查"><a href="#文档的增删改查" class="headerlink" title="文档的增删改查"></a>文档的增删改查</h3><p>访问elasticsearch文档的模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;HTTP方法&gt; &lt;节点&gt;:&lt;端口号&gt;/&lt;索引名&gt;/&lt;类型名&gt;/&lt;ID&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>创建文档</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/test/_doc?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "method" : "create",</span></span><br><span class="line"><span class="string">    "service" : "sms",</span></span><br><span class="line"><span class="string">    "data" : "&#123;\"phone\":\"18860469266\",\"templateCode\":\"SMS_123673036\",\"content\":\"会员 刘祥 您好,您已经成功预约课程: 强力拉伸,上课时间：2017-12-18 20:30 \",\"fee\":0.045&#125;",</span></span><br><span class="line"><span class="string">    "club" : "5a7155a9fb5a680009103975",</span></span><br><span class="line"><span class="string">    "company" : "5a4b50fc07bf9d0005fabcf5",</span></span><br><span class="line"><span class="string">    "createdAt" : "2018-01-31T05:45:40.936Z"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> elasticsearch 会自动帮我们生成一个自动增加的 _id 或者 uuid，注意这里的 POST 不能改成 PUT，如果把 POST 改成 PUT 那么就会报错：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"error"</span>:<span class="string">"Incorrect HTTP method for uri [/test/_doc] and method [PUT], allowed: [POST]"</span>,<span class="string">"status"</span>:405&#125;</span><br></pre></td></tr></table></figure>
<p> 如果要新建一个指定 id 的项目的话，可以使用 PUT：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test/_doc/5a7152e48dd0b100064f34b5?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "method" : "create",</span></span><br><span class="line"><span class="string">    "ip" : "222.94.74.27",</span></span><br><span class="line"><span class="string">    "browser" : "chrome64.0.3282.119",</span></span><br><span class="line"><span class="string">    "service" : "login",</span></span><br><span class="line"><span class="string">    "data" : "&#123;\"target\":\"operation\",\"strategy\":\"staff\",\"username\":\"XXX001\",\"password\":\"14asvqrg\"&#125;",</span></span><br><span class="line"><span class="string">    "createdAt" : "2018-01-31T05:23:48.150Z"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> 如果 id 没有被使用，那么就是用给定的 id 进行创建，如果 id 已被占用的话，会覆盖原来的数据！所以不能使用这种方式进行指定id的创建，用下面的命令替代（<code>_create</code>可以换成<code>?op_type=create</code>）：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1/_create?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "method" : "create",</span></span><br><span class="line"><span class="string">    "browser" : "postmanruntime/6.4.1",</span></span><br><span class="line"><span class="string">    "service" : "sms",</span></span><br><span class="line"><span class="string">    "data" : "&#123;\"phone\":\"18375330275\",\"templateCode\":\"SMS_123797855\",\"fee\":0&#125;",</span></span><br><span class="line"><span class="string">    "_doc" : "5a7155a9fb5a68000910397f",</span></span><br><span class="line"><span class="string">    "club" : "5a7155a9fb5a680009103975",</span></span><br><span class="line"><span class="string">    "company" : "5a4b50fc07bf9d0005fabcf5",</span></span><br><span class="line"><span class="string">    "createdAt" : "2018-01-31T05:51:57.858Z"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p> 如果查到 id 已经存在，那么会返回 error，http 状态码是 409。注意最后跟在 id 后面的_create不能少，如果没带这个的话就会覆盖原来已经存在的！（我发现把上面的PUT换成POST也是可以）</p>
</li>
<li><p>查询文档</p>
<ol>
<li><p>查询指定文档（单个数据）：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<pre><code>    返回结果分析：

    <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"_index"</span> : <span class="string">"test_v1"</span>,</span><br><span class="line">    <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">    <span class="attr">"_id"</span> : <span class="string">"5a71597d8dd0b100064f34c1"</span>,</span><br><span class="line">    <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"_source"</span> : &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    - `_index` 是索引
    - `_type` 是类型
    - `_id `是文档编号
    - `_version `是修改次数
    - `found` 是是否找到
    - `_source` 是数据详情。

    可以指定直接获取 _source:

    <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1/_source?pretty'</span></span><br></pre></td></tr></table></figure>

2. 查询所有文档：

    <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_search?pretty'</span></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span></span><br></pre></td></tr></table></figure>


    返回结果案例：

    <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;	</span><br><span class="line"><span class="attr">"took"</span> : <span class="number">98</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">16</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">16</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">30</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [ &#123;</span><br><span class="line">      <span class="attr">"_index"</span> : <span class="string">".kibana"</span>,</span><br><span class="line">      <span class="attr">"_type"</span> : <span class="string">"index-pattern"</span>,</span><br><span class="line">      <span class="attr">"_id"</span> : <span class="string">"cn.elixiao.search"</span>,</span><br><span class="line">      <span class="attr">"_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">      <span class="attr">"_source"</span> : &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    - took 是整个搜索花费的毫秒数
    - time_out是查询是否超时
    - _shards是参与查询的分片总数，(total)中有多少是成功的(successful)或失败的(failed）
    - hits中total是匹配到的文档总数，max_score是给文档做相关性评分的最大值，hits数组是前10条数据。
</code></pre><ol>
<li><p>修改文档</p>
<p> PUT会基于id修改数据，如果这个ID已经存在数据，那么原数据将会被覆盖，如果要局部修改则需要：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/test/_doc/5a71597d8dd0b100064f34c1/_update?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "doc":&#123;</span></span><br><span class="line"><span class="string">    		"browser": "Chrome",</span></span><br><span class="line"><span class="string">      		"about": "I like shopping"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>注意这里的POST不能换成PUT，否则也会报类似的错误。

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Incorrect HTTP method for uri [/test/_doc/5a71597d8dd0b100064f34c1/_update?pretty] and method [PUT], allowed: [POST]</span><br></pre></td></tr></table></figure>

还要注意，doc里面的内容是被更新的内容，如果有这个字段就更新，如果没有这个字段就添加。
</code></pre><ol>
<li><p>删除文档</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">'localhost:9200/test/_doc/_id'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="查询进阶"><a href="#查询进阶" class="headerlink" title="查询进阶"></a>查询进阶</h2><ol>
<li><p>指定查询字段：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_id?_source=method,data&amp;pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>只保留 <code>_source</code> 数据：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_id/_source?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检查文档是否存在（存在返回200，否则返回404）</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I -XHEAD <span class="string">'localhost:9200/test/_doc/_id?pretty'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询多个文档（muti-get）</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_mget?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "docs" : [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">         "_index" : "test",</span></span><br><span class="line"><span class="string">         "_type" :  "_doc",</span></span><br><span class="line"><span class="string">         "_id" :    2</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">         "_index" : "cn.elixiao.search",</span></span><br><span class="line"><span class="string">         "_type" :  "tweet",</span></span><br><span class="line"><span class="string">         "_id" :    1,</span></span><br><span class="line"><span class="string">         "_source": "views"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">   ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>过滤文档（分页）</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/_search?pretty&apos; -H &apos;Content-Type: application/json&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;from&quot;:2,</span><br><span class="line">	&quot;size&quot;:2</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>- size是结果数量，默认是10
- from是跳过开始的结果数，默认是0。

由于RFC 7231标准里面没有定义GET请求的request body，所以可以用POST请求或者下面的方法：

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/_search?from=2&amp;size=2&amp;pretty&apos;</span><br></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>查看所有索引和类型：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET &apos;localhost:9200/_mapping?pretty&apos;</span><br></pre></td></tr></table></figure>
<p>​</p>
<h2 id="查询DSL"><a href="#查询DSL" class="headerlink" title="查询DSL"></a>查询DSL</h2></li>
</ol>
<h3 id="一、简易查询（将所有参数放在查询字符串里面）"><a href="#一、简易查询（将所有参数放在查询字符串里面）" class="headerlink" title="一、简易查询（将所有参数放在查询字符串里面）"></a>一、简易查询（将所有参数放在查询字符串里面）</h3><p>查询test索引里面_doc类型中method字段包含patch的所有结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?q=method:patch&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>查询test索引里面_doc类型中method字段包含create，service字段包含sms的所有结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?q=+method:create+service:sms&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>注意这时候如果 method 有 create，service 不是 sms 的也会出现在结果里面，这是因为ES的结果是按照相关性排序的，由于 method 中出现了 create，所以有一定的相关性，但score会比较低。如果不指定索引、类型和字段，直接用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?q=post&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>会把所有索引不同类型任意字段中包含 post 的都找出来了。其实 ES 会把文档的所有字符串字段的值连接起来放在一个大的字符串中，它被索引为一个特殊的字段_all。因此可以构造更为复杂的查询：last_name为Smith，first_name为Jane，age小于30，任意字段中包含sports的结果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?q=+last_name:Smith+first_name:Jane+age:&lt;30+sports&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>排序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?sort=service:asc&amp;pretty'</span></span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "sort" : [</span></span><br><span class="line"><span class="string">        &#123; "service" : &#123;"order" : "asc"&#125; &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>如果出现下面的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [service] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.</span><br></pre></td></tr></table></figure>
<p> 默认 Elasticsearch 对 text 类型的字段是不可聚合的，基本类型可聚合，设置Fielddata = true 即可。</p>
<h3 id="二、结构化查询"><a href="#二、结构化查询" class="headerlink" title="二、结构化查询"></a>二、结构化查询</h3><p>查询 DSL 包括 query DSL 和 filter DSL，它们之间的区别就是 filters 会被缓存且不影响得分，比 query 更快。filter 常常用于精确匹配，query 用于全文搜索</p>
<h4 id="query-DSL"><a href="#query-DSL" class="headerlink" title="query DSL"></a>query DSL</h4><p>语法格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search'</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"query"</span>: YOUR_QUERY_HERE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YOUR_QUERY_HERE查询子句里面的语法格式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        ARGUMENT: VALUE,</span><br><span class="line">        ARGUMENT: VALUE,...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果限制在特定的字段，用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        FIELD_NAME: &#123;</span><br><span class="line">            ARGUMENT: VALUE,</span><br><span class="line">            ARGUMENT: VALUE,...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如你可以查询所有姓 Smith 的文档</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "last_name": "Smith"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>中文分词</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/cn.elixiao.search/tweet/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "message": "今天"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/index/fulltext/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "content": "伊拉克"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/index/fulltext/_mapping?pretty'</span></span><br><span class="line">	</span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "multi_match": &#123;</span></span><br><span class="line"><span class="string">            "last_name": "Smith",</span></span><br><span class="line"><span class="string">            "first_name": "Jane"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>指定多字段多查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "multi_match": &#123;</span></span><br><span class="line"><span class="string">            "query": "reading",</span></span><br><span class="line"><span class="string">            "fields": ["interests","about"]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>指定关键词全部匹配：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "about": "like reading"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>这个查询会把about字段里面只要包含like和reading其中一个都搜索出来，如果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "about": &#123;</span></span><br><span class="line"><span class="string">                "query":    "like reading",</span></span><br><span class="line"><span class="string">                "operator": "and"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>这样就能把about字段里面既包含like又包含reading的搜出来了。其实还有一种更灵活的方式来控制搜索结果，minimum_should_match选项可以指定最少应该匹配的数量。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "about": &#123;</span></span><br><span class="line"><span class="string">                "query":    "like reading rock",</span></span><br><span class="line"><span class="string">                "minimum_should_match": "2"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>由于事先不确定用户会输入的关键词数量，这里可以设置为百分比，例如75%。</p>
<p>合并查询子句：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"bool"</span>: &#123;</span><br><span class="line">        <span class="string">"must"</span>:     &#123; <span class="string">"match"</span>: &#123; <span class="string">"tweet"</span>: <span class="string">"elasticsearch"</span> &#125;&#125;,</span><br><span class="line">        <span class="string">"must_not"</span>: &#123; <span class="string">"match"</span>: &#123; <span class="string">"name"</span>:  <span class="string">"mary"</span> &#125;&#125;,</span><br><span class="line">        <span class="string">"should"</span>:   &#123; <span class="string">"match"</span>: &#123; <span class="string">"tweet"</span>: <span class="string">"full text"</span> &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中：must：必须匹配，must_no：不许匹配，should：如果匹配的话得分更高，完整的案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"query": &#123;</span></span><br><span class="line"><span class="string">		"bool": &#123;</span></span><br><span class="line"><span class="string">			"must": &#123;</span></span><br><span class="line"><span class="string">				"match": &#123;</span></span><br><span class="line"><span class="string">					"sex": "男"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			"must_not": &#123;</span></span><br><span class="line"><span class="string">				"match": &#123;</span></span><br><span class="line"><span class="string">					"name": "Smith"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			"should": &#123;</span></span><br><span class="line"><span class="string">				"match": &#123;</span></span><br><span class="line"><span class="string">					"hobby": "reading"</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>如果如果没传body，即空的{}，等价于：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search'</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"query"</span>: &#123;</span><br><span class="line">		<span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="filter-DSL"><a href="#filter-DSL" class="headerlink" title="filter DSL"></a>filter DSL</h4><p>区间过滤（range）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"range": &#123;</span></span><br><span class="line"><span class="string">			"age": &#123;</span></span><br><span class="line"><span class="string">				"gt":  20,</span></span><br><span class="line"><span class="string">				"lte":   30</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>存在性过滤（exists）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"exists": &#123;</span></span><br><span class="line"><span class="string">			"field": "age"</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>缺失值过滤（missing）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"missing": &#123;</span></span><br><span class="line"><span class="string">			"field": "age"</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>精确匹配过滤（term）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"term": &#123;</span></span><br><span class="line"><span class="string">			"age": "33"</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>term 和 match的区别在于 match 会对查询语句进行分词，而 term 则搜索完整的语句，不做任何分词。（注意是查询语句，而不是数据库里面的字符串字段，如非特别标注，数据库里面的字符串字段总是会分词的）<br>​<br>多条件精确匹配过滤（terms）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter": &#123;</span></span><br><span class="line"><span class="string">		"terms": &#123;</span></span><br><span class="line"><span class="string">			"about": ["like","rock"]</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>排序（例如按照年龄进行倒序）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter" : &#123;</span></span><br><span class="line"><span class="string">		"range": &#123;</span></span><br><span class="line"><span class="string">			"age": &#123;</span></span><br><span class="line"><span class="string">				"gt":  20,</span></span><br><span class="line"><span class="string">				"lte": 30</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"sort": &#123; "age": &#123; "order": "desc" &#125;&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>当指定排序的时候，_score 字段就不会被计算，因为它没有用作排序。作为缩写，你可以只指定要排序的字段名称，例如：”sort”: “age”，那么字段值默认以顺序排列，这一点与_score默认以倒序排列不同。如果想指定多个排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"filter" : &#123;</span></span><br><span class="line"><span class="string">		"range": &#123;</span></span><br><span class="line"><span class="string">			"age": &#123;</span></span><br><span class="line"><span class="string">				"gt":  20,</span></span><br><span class="line"><span class="string">				"lte": 30</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"sort": [</span></span><br><span class="line"><span class="string">        &#123; "age":   &#123; "order": "desc" &#125;&#125;,</span></span><br><span class="line"><span class="string">        &#123; "first_name": &#123; "order": "asc" &#125;&#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>还有一种情况是，如果一个字段是一个集合，拥有多个值，那是否可以指定其中一个作为排序依据呢？答案是肯定的：对于数字和日期，你可以从多个值中取出一个来进行排序，你可以使用min, max, avg 或 sum这些模式， 比说你可以在 dates 字段中用最早的日期来进行排序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"sort"</span>: &#123;</span><br><span class="line">    <span class="string">"dates"</span>: &#123;</span><br><span class="line">        <span class="string">"order"</span>: <span class="string">"asc"</span>,</span><br><span class="line">        <span class="string">"mode"</span>:  <span class="string">"min"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而对于多值字段字符串排序这种方法就不行了。比如字符串 “fine old art”，它最终会得到三个值。例如我们想要按照第一个词首字母排序， 如果第一个单词相同的话，再用第二个词的首字母排序，以此类推，可惜 ElasticSearch 在进行排序时 是得不到这些信息的。如果使用 min 和 max 模式来排（默认使用的是 min 模式）但它是依据art 或者 old排序， 而不是我们所期望的那样。</p>
<h4 id="query-和-filter-之间的比较"><a href="#query-和-filter-之间的比较" class="headerlink" title="query 和 filter 之间的比较"></a>query 和 filter 之间的比较</h4><ul>
<li>Query: 文档和查询条件之间的匹配程度如何？（How well a document matches the query）</li>
<li>Filter: 文档是否匹配查询条件？（Whether a document matches the query）</li>
</ul>
<p>具体的示例如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST localhost:9200/myindex/mytype  -d <span class="string">'&#123; "msg": "Hello world!" &#125;'</span></span><br><span class="line">curl -XPOST localhost:9200/myindex/mytype  -d <span class="string">'&#123; "msg": "Hello world! I am Sam." &#125;'</span></span><br><span class="line">curl -XPOST localhost:9200/myindex/mytype  -d <span class="string">'&#123; "msg": "Hi Stack Overflow!" &#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9200/myindex/_search?pretty  -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123; "bool": &#123; "must": &#123; "match": &#123; "msg": "hello sam" &#125;&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>文档 “Hello world! I am Sam.” 比 “Hello world!” 得分更高，因为匹配到了两个词。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;hits&quot; : [</span><br><span class="line">   ...</span><br><span class="line">     &quot;_score&quot; : 0.74487394,</span><br><span class="line">     &quot;_source&quot; : &#123;</span><br><span class="line">       &quot;name&quot; : &quot;Hello world! I am Sam.&quot;</span><br><span class="line">     &#125;</span><br><span class="line">   ...</span><br><span class="line">     &quot;_score&quot; : 0.22108285,</span><br><span class="line">     &quot;_source&quot; : &#123;</span><br><span class="line">       &quot;name&quot; : &quot;Hello world!&quot;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9200/myindex/_search?pretty  -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;bool&quot;: &#123; &quot;filter&quot;: &#123; &quot;match&quot;: &#123; &quot;msg&quot;: &quot;hello sam&quot; &#125;&#125;&#125;&#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>从下面的返回结果中可以看到，文档没有评分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;hits&quot; : [</span><br><span class="line">   ...</span><br><span class="line">     &quot;_score&quot; : 0.0,</span><br><span class="line">     &quot;_source&quot; : &#123;</span><br><span class="line">       &quot;name&quot; : &quot;Hello world!&quot;</span><br><span class="line">     &#125;</span><br><span class="line">   ...</span><br><span class="line">     &quot;_score&quot; : 0.0,</span><br><span class="line">     &quot;_source&quot; : &#123;</span><br><span class="line">       &quot;name&quot; : &quot;Hello world! I am Sam.&quot;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、查询和过滤混用"><a href="#四、查询和过滤混用" class="headerlink" title="四、查询和过滤混用"></a>四、查询和过滤混用</h3><p>单条过滤语句：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "filtered": &#123;</span></span><br><span class="line"><span class="string">            "filter":   &#123; "term": &#123; "folder": "inbox" &#125;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>带过滤的查询语句：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "filtered": &#123;</span></span><br><span class="line"><span class="string">            "query":  &#123; "match": &#123; "email": "business opportunity" &#125;&#125;,</span></span><br><span class="line"><span class="string">            "filter": &#123; "term": &#123; "folder": "inbox" &#125;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>验证查询：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/_validate/query?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "query": &#123;</span></span><br><span class="line"><span class="string">      "_doc" : &#123;</span></span><br><span class="line"><span class="string">         "match" : "really powerful"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/_validate/query?pretty&amp;explain'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   "query": &#123;</span></span><br><span class="line"><span class="string">      "_doc" : &#123;</span></span><br><span class="line"><span class="string">         "match" : "really powerful"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>body里面：</p>
<p>sort<br>filter<br>query<br>from<br>size<br>aggs<br>_source</p>
<h3 id="五、批量操作"><a href="#五、批量操作" class="headerlink" title="五、批量操作"></a>五、批量操作</h3><p>批量操作文档（bulk）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">'localhost:9200/_bulk</span></span><br></pre></td></tr></table></figure>
<pre><code>{ &quot;delete&quot;: { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; }} 
{ &quot;create&quot;: { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; }}
{ &quot;title&quot;:    &quot;My first blog post&quot; }
{ &quot;index&quot;:  { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot; }}
{ &quot;title&quot;:    &quot;My second blog post&quot; }
{ &quot;update&quot;: { &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot;, &quot;_retry_on_conflict&quot; : 3} }
{ &quot;doc&quot; : {&quot;title&quot; : &quot;My updated blog post&quot;} } 

一次性完成删除、指定id的创建、自动生成id的创建和更新。返回结果可能是这样的：

    {
       &quot;took&quot;: 4,
       &quot;errors&quot;: false, 
       &quot;items&quot;: [
          {  &quot;delete&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;123&quot;,
                &quot;_version&quot;: 2,
                &quot;status&quot;:   200,
                &quot;found&quot;:    true
          }},
          {  &quot;create&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;123&quot;,
                &quot;_version&quot;: 3,
                &quot;status&quot;:   201
          }},
          {  &quot;create&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;EiwfApScQiiy7TIKFxRCTw&quot;,
                &quot;_version&quot;: 1,
                &quot;status&quot;:   201
          }},
          {  &quot;update&quot;: {
                &quot;_index&quot;:   &quot;website&quot;,
                &quot;_type&quot;:    &quot;blog&quot;,
                &quot;_id&quot;:      &quot;123&quot;,
                &quot;_version&quot;: 4,
                &quot;status&quot;:   200
          }}
       ]
    }
</code></pre><p>对查询结果进行批量删除：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">"localhost:9200/test/_doc/_query?pretty"</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "age": "30"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200//test/_doc/_search?q=last_name:Smith&amp;pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query" : &#123;</span></span><br><span class="line"><span class="string">        "filtered" : &#123;</span></span><br><span class="line"><span class="string">            "filter" : &#123;</span></span><br><span class="line"><span class="string">                "range" : &#123;</span></span><br><span class="line"><span class="string">                    "age" : &#123; "gt" : 30 &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "query" : &#123;</span></span><br><span class="line"><span class="string">                "match" : &#123;</span></span><br><span class="line"><span class="string">                    "last_name" : "Smith"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "query" : &#123;</span></span><br><span class="line"><span class="string">        "match_phrase" : &#123;</span></span><br><span class="line"><span class="string">            "about" : "rock climbing"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">	"highlight": &#123;</span></span><br><span class="line"><span class="string">        "fields" : &#123;</span></span><br><span class="line"><span class="string">            "about" : &#123;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XGET <span class="string">'localhost:9200/test/_doc/_search?pretty'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	"query" : &#123;</span></span><br><span class="line"><span class="string">        "match" : &#123;</span></span><br><span class="line"><span class="string">            "last_name" : "smith"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">  "aggs": &#123;</span></span><br><span class="line"><span class="string">    "all_interests": &#123;</span></span><br><span class="line"><span class="string">      "terms": &#123; "field": "interests" &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<h2 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h2><p>ES 版本升级之后，是不支持降级的，因此在升级 ES 版本之前，一定要备份好数据。备份方式也很简单，首先全局安装 elasticdump：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn global add elasticdump</span><br></pre></td></tr></table></figure>
<p>然后执行全量导出命令可以把所有索引备份到指定目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">multielasticdump \</span><br><span class="line">  --direction=dump \</span><br><span class="line">  --match=<span class="string">'^.*$'</span> \</span><br><span class="line">  --input=http://localhost:9200 \</span><br><span class="line">  --output=/mnt/bak/es/dump</span><br></pre></td></tr></table></figure>
<p>从目录中恢复数据：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">multielasticdump \</span><br><span class="line">  --direction=load \</span><br><span class="line">  --match=<span class="string">'^.*$'</span> \</span><br><span class="line">  --input=/mnt/bak/es/dump \</span><br><span class="line">  --output=http://localhost:9200</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
     <a data-url="https://zju.date/es-notes/" data-id="ckej9qfya00bzwpq4k0jaeus4" class="article-share-link">Share</a>
     
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/gulp-notes/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Gulp学习笔记
        
      </div>
    </a>
  
  
    <a href="/git-notes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Git学习笔记</div>
    </a>
  
</nav>

  
</article>

</section>

        

      </div>
      <footer id="footer">
  
    <aside id="sidebar" class="outer">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CFA/">CFA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dart/">Dart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flutter/">Flutter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小程序/">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/诗歌/">诗歌</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
</aside>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 zju.date
      &nbsp;&nbsp;&nbsp;
      contact: <a href="mailto:zju.date@qq.com">zju.date@qq.com</a>
    </div>
  </div>
</footer>


    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });

</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>

<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>